(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "ama supercross - race": "ama supercross - race",
  "anaheim ducks": "anaheim ducks",
  "arizona cardinals": "arizona cardinals",
  "atlanta falcons": "atlanta falcons",
  "atlanta hawks": "atlanta hawks",
  "atlético madrid": "atlético madrid",
  "baltimore ravens": "baltimore ravens",
  "boston celtics": "boston celtics",
  "brooklyn nets": "brooklyn nets",
  "buffalo bills": "buffalo bills",
  "calgary flames": "calgary flames",
  "carolina hurricanes": "carolina hurricanes",
  "charlotte hornets": "charlotte hornets",
  "chicago bears": "chicago bears",
  "chicago blackhawks": "chicago blackhawks",
  "chicago bulls": "chicago bulls",
  "cincinnati bengals": "cincinnati bengals",
  "cleveland browns": "cleveland browns",
  "cleveland cavaliers": "cleveland cavaliers",
  "colorado avalanche": "colorado avalanche",
  "columbus blue jackets": "columbus blue jackets",
  "dallas cowboys": "dallas cowboys",
  "dallas stars": "dallas stars",
  "denver broncos": "denver broncos",
  "denver nuggets": "denver nuggets",
  "detroit lions": "detroit lions",
  "detroit pistons": "detroit pistons",
  "detroit red wings": "detroit red wings",
  "florida panthers": "florida panthers",
  "formula e - grand prix": "formula e - grand prix",
  "galatasaray": "galatasaray",
  "golden state warriors": "golden state warriors",
  "green bay packers": "green bay packers",
  "houston rockets": "houston rockets",
  "houston texans": "houston texans",
  "indiana pacers": "indiana pacers",
  "indianapolis colts": "indianapolis colts",
  "jacksonville jaguars": "jacksonville jaguars",
  "kansas city chiefs": "kansas city chiefs",
  "las vegas raiders": "las vegas raiders",
  "leicester city": "leicester city",
  "los angeles chargers": "los angeles chargers",
  "los angeles clippers": "los angeles clippers",
  "los angeles kings": "los angeles kings",
  "los angeles lakers": "los angeles lakers",
  "los angeles rams": "los angeles rams",
  "memphis grizzlies": "memphis grizzlies",
  "miami dolphins": "miami dolphins",
  "miami heat": "miami heat",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota timberwolves": "minnesota timberwolves",
  "minnesota vikings": "minnesota vikings",
  "minnesota wild": "minnesota wild",
  "montreal canadiens": "montreal canadiens",
  "new england patriots": "new england patriots",
  "new jersey devils": "new jersey devils",
  "new orleans pelicans": "new orleans pelicans",
  "new orleans saints": "new orleans saints",
  "new york giants": "new york giants",
  "new york jets": "new york jets",
  "new york knicks": "new york knicks",
  "new york rangers": "new york rangers",
  "nfl redzone": "nfl redzone",
  "north central": "north central",
  "oklahoma city thunder": "oklahoma city thunder",
  "orlando magic": "orlando magic",
  "ottawa senators": "ottawa senators",
  "paris": "paris",
  "philadelphia 76ers": "philadelphia 76ers",
  "philadelphia eagles": "philadelphia eagles",
  "phoenix suns": "phoenix suns",
  "pittsburgh penguins": "pittsburgh penguins",
  "pittsburgh steelers": "pittsburgh steelers",
  "portland trail blazers": "portland trail blazers",
  "psg": "psg",
  "real sociedad": "real sociedad",
  "sacramento kings": "sacramento kings",
  "seattle kraken": "seattle kraken",
  "serrano": "serrano",
  "telles": "telles",
  "tennessee titans": "tennessee titans",
  "toronto raptors": "toronto raptors",
  "trabzonspor": "trabzonspor",
  "utah jazz": "utah jazz",
  "utah mammoth": "utah mammoth",
  "vegas golden knights": "vegas golden knights",
  "washington capitals": "washington capitals",
  "washington commanders": "washington commanders",
  "washington wizards": "washington wizards",
  "west bromwich albion": "west bromwich albion",
  "wisconsin-river falls": "wisconsin-river falls",
  "hawks": "atlanta hawks",
  "celtics": "boston celtics",
  "hornets": "charlotte hornets",
  "bulls": "chicago bulls",
  "cavaliers": "cleveland cavaliers",
  "nuggets": "denver nuggets",
  "pistons": "detroit pistons",
  "warriors": "golden state warriors",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "lakers": "los angeles lakers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "magic": "orlando magic",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "raptors": "toronto raptors",
  "jazz": "utah jazz",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "galatasaray vs trabzonspor", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "leicester city vs west bromwich albion", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "paris vs psg", url: "https://roxiestreams.live/soccer-streams-13"},
  {title: "atlético madrid vs real sociedad", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "cleveland cavaliers vs detroit pistons", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "indiana pacers vs orlando magic", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "brooklyn nets vs denver nuggets", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "miami heat vs new orleans pelicans", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "minnesota timberwolves vs washington wizards", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "oklahoma city thunder vs phoenix suns", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "milwaukee bucks vs sacramento kings", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "los angeles lakers vs memphis grizzlies", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "detroit pistons vs new york knicks", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "boston celtics vs chicago bulls", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "atlanta hawks vs toronto raptors", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "houston rockets vs phoenix suns", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "charlotte hornets vs oklahoma city thunder", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "denver nuggets vs philadelphia 76ers", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "golden state warriors vs los angeles clippers", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "portland trail blazers vs utah jazz", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "dallas stars vs montreal canadiens", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "columbus blue jackets vs pittsburgh penguins", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "colorado avalanche vs florida panthers", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "carolina hurricanes vs new jersey devils", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "chicago blackhawks vs vegas golden knights", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "new york rangers vs utah mammoth", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "anaheim ducks vs washington capitals", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "detroit red wings vs ottawa senators", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "calgary flames vs seattle kraken", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "los angeles kings vs minnesota wild", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "formula e - grand prix", url: "https://roxiestreams.live/f1-streams"},
  {title: "ama supercross - race", url: "https://roxiestreams.live/supercross"},
  {title: "serrano vs telles", url: "https://roxiestreams.live/ppv-streams-1"},
  {title: "nfl redzone", url: "https://roxiestreams.live/redzone"},
  {title: "atlanta falcons vs new orleans saints", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "cincinnati bengals vs cleveland browns", url: "https://roxiestreams.live/nfl-streams-2"},
  {title: "green bay packers vs minnesota vikings", url: "https://roxiestreams.live/nfl-streams-3"},
  {title: "dallas cowboys vs new york giants", url: "https://roxiestreams.live/nfl-streams-4"},
  {title: "jacksonville jaguars vs tennessee titans", url: "https://roxiestreams.live/nfl-streams-5"},
  {title: "houston texans vs indianapolis colts", url: "https://roxiestreams.live/nfl-streams-6"},
  {title: "buffalo bills vs new york jets", url: "https://roxiestreams.live/nfl-streams-7"},
  {title: "chicago bears vs detroit lions", url: "https://roxiestreams.live/nfl-streams-8"},
  {title: "denver broncos vs los angeles chargers", url: "https://roxiestreams.live/nfl-streams-9"},
  {title: "kansas city chiefs vs las vegas raiders", url: "https://roxiestreams.live/nfl-streams-10"},
  {title: "arizona cardinals vs los angeles rams", url: "https://roxiestreams.live/nfl-streams-11"},
  {title: "miami dolphins vs new england patriots", url: "https://roxiestreams.live/nfl-streams-12"},
  {title: "philadelphia eagles vs washington commanders", url: "https://roxiestreams.live/nfl-streams-13"},
  {title: "baltimore ravens vs pittsburgh steelers", url: "https://roxiestreams.live/nfl-streams-14"},
  {title: "north central vs wisconsin-river falls", url: "https://roxiestreams.live/ncaa-streams-1"}
];

  const nbaTeams = new Set(["los angeles lakers","new orleans pelicans","washington wizards","los angeles clippers","toronto raptors","philadelphia 76ers","milwaukee bucks","minnesota timberwolves","oklahoma city thunder","portland trail blazers","miami heat","indiana pacers","new york knicks","phoenix suns","denver nuggets","golden state warriors","san antonio spurs","sacramento kings","dallas mavericks","atlanta hawks","charlotte hornets","boston celtics","detroit pistons","cleveland cavaliers","houston rockets","orlando magic","memphis grizzlies","utah jazz","chicago bulls"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.live/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.live/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.live/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.live/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.live/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.live/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
