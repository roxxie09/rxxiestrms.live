(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "al najma": "al najma",
  "al nassr": "al nassr",
  "anaheim ducks": "anaheim ducks",
  "arizona cardinals": "arizona cardinals",
  "aston villa": "aston villa",
  "atalanta": "atalanta",
  "atlanta falcons": "atlanta falcons",
  "atlanta hawks": "atlanta hawks",
  "atlético madrid": "atlético madrid",
  "auxerre": "auxerre",
  "baltimore ravens": "baltimore ravens",
  "barcelona": "barcelona",
  "bayern münchen": "bayern münchen",
  "bolivia": "bolivia",
  "boston bruins": "boston bruins",
  "boston celtics": "boston celtics",
  "bourg en bresse": "bourg en bresse",
  "brooklyn nets": "brooklyn nets",
  "buffalo bills": "buffalo bills",
  "buffalo sabres": "buffalo sabres",
  "calgary flames": "calgary flames",
  "carolina hurricanes": "carolina hurricanes",
  "carolina panthers": "carolina panthers",
  "charlotte hornets": "charlotte hornets",
  "chase demoor": "chase demoor",
  "chicago bears": "chicago bears",
  "chicago blackhawks": "chicago blackhawks",
  "chicago bulls": "chicago bulls",
  "cincinnati bengals": "cincinnati bengals",
  "cleveland browns": "cleveland browns",
  "colorado avalanche": "colorado avalanche",
  "columbus blue jackets": "columbus blue jackets",
  "corinthians": "corinthians",
  "dallas cowboys": "dallas cowboys",
  "dallas mavericks": "dallas mavericks",
  "dallas stars": "dallas stars",
  "denver broncos": "denver broncos",
  "denver nuggets": "denver nuggets",
  "detroit lions": "detroit lions",
  "detroit pistons": "detroit pistons",
  "detroit red wings": "detroit red wings",
  "edmonton oilers": "edmonton oilers",
  "elche": "elche",
  "florida panthers": "florida panthers",
  "galatasaray": "galatasaray",
  "genoa": "genoa",
  "getafe": "getafe",
  "girona": "girona",
  "golden state warriors": "golden state warriors",
  "green bay packers": "green bay packers",
  "hearts": "hearts",
  "heidenheim": "heidenheim",
  "houston rockets": "houston rockets",
  "houston texans": "houston texans",
  "indiana pacers": "indiana pacers",
  "jacksonville jaguars": "jacksonville jaguars",
  "james madison": "james madison",
  "kansas city chiefs": "kansas city chiefs",
  "kasımpaşa": "kasımpaşa",
  "kubota high limit racing - prelim night 1": "kubota high limit racing - prelim night 1",
  "kubota high limit racing - prelim night 2": "kubota high limit racing - prelim night 2",
  "kubota high limit racing - race": "kubota high limit racing - race",
  "las vegas raiders": "las vegas raiders",
  "los angeles clippers": "los angeles clippers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles lakers": "los angeles lakers",
  "los angeles rams": "los angeles rams",
  "manchester united": "manchester united",
  "marseille": "marseille",
  "memphis grizzlies": "memphis grizzlies",
  "miami (fl)": "miami (fl)",
  "miami dolphins": "miami dolphins",
  "miami heat": "miami heat",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota timberwolves": "minnesota timberwolves",
  "minnesota vikings": "minnesota vikings",
  "minnesota wild": "minnesota wild",
  "misfits mania: andrew tate": "misfits mania: andrew tate",
  "monaco": "monaco",
  "montreal canadiens": "montreal canadiens",
  "nashville predators": "nashville predators",
  "new england patriots": "new england patriots",
  "new jersey devils": "new jersey devils",
  "new orleans pelicans": "new orleans pelicans",
  "new orleans saints": "new orleans saints",
  "new york": "new york",
  "new york islanders": "new york islanders",
  "new york knicks": "new york knicks",
  "new york rangers": "new york rangers",
  "ole miss": "ole miss",
  "oregon": "oregon",
  "orlando magic": "orlando magic",
  "ottawa senators": "ottawa senators",
  "peru": "peru",
  "pfl africa 4": "pfl africa 4",
  "philadelphia 76ers": "philadelphia 76ers",
  "philadelphia eagles": "philadelphia eagles",
  "philadelphia flyers": "philadelphia flyers",
  "phoenix suns": "phoenix suns",
  "pittsburgh penguins": "pittsburgh penguins",
  "pittsburgh steelers": "pittsburgh steelers",
  "portland trail blazers": "portland trail blazers",
  "raners": "raners",
  "rayo vallecano": "rayo vallecano",
  "real betis": "real betis",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "san jose sharks": "san jose sharks",
  "sassuolo": "sassuolo",
  "seattle kraken": "seattle kraken",
  "st. louis blues": "st. louis blues",
  "tampa bay buccaneers": "tampa bay buccaneers",
  "tampa bay lightning": "tampa bay lightning",
  "tennessee titans": "tennessee titans",
  "texas a&m": "texas a&m",
  "torino": "torino",
  "toronto blue jays": "toronto blue jays",
  "toronto maple leafs": "toronto maple leafs",
  "toronto raptors": "toronto raptors",
  "tulane": "tulane",
  "utah jazz": "utah jazz",
  "utah mammoth": "utah mammoth",
  "vancouver canucks": "vancouver canucks",
  "vasco da gama": "vasco da gama",
  "vegas golden knights": "vegas golden knights",
  "villarreal": "villarreal",
  "washington capitals": "washington capitals",
  "washington commanders": "washington commanders",
  "washington wizards": "washington wizards",
  "winnipeg jets": "winnipeg jets",
  "hawks": "atlanta hawks",
  "celtics": "boston celtics",
  "hornets": "charlotte hornets",
  "bulls": "chicago bulls",
  "mavericks": "dallas mavericks",
  "nuggets": "denver nuggets",
  "pistons": "detroit pistons",
  "warriors": "golden state warriors",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "lakers": "los angeles lakers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "magic": "orlando magic",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors",
  "jazz": "utah jazz",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "atlético madrid vs girona", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "hearts vs raners", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "auxerre vs monaco", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "bourg en bresse vs marseille", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "sassuolo vs torino", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "barcelona vs villarreal", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "bayern münchen vs heidenheim", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "aston villa vs manchester united", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "galatasaray vs kasımpaşa", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "al najma vs al nassr", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "elche vs rayo vallecano", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "atalanta vs genoa", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "getafe vs real betis", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "bolivia vs peru", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "corinthians vs vasco da gama", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "denver nuggets vs houston rockets", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "dallas mavericks vs philadelphia 76ers", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "boston celtics vs toronto raptors", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "indiana pacers vs new orleans pelicans", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "charlotte hornets vs detroit pistons", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "memphis grizzlies vs washington wizards", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "golden state warriors vs phoenix suns", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "orlando magic vs utah jazz", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "portland trail blazers vs sacramento kings", url: "https://roxiestreams.live/nba-streams-9"},
  {title: "los angeles clippers vs los angeles lakers", url: "https://roxiestreams.live/nba-streams-10"},
  {title: "atlanta hawks vs chicago bulls", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "brooklyn nets vs toronto raptors", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "miami heat vs new york knicks", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "san antonio spurs vs washington wizards", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "milwaukee bucks vs minnesota timberwolves", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "houston rockets vs sacramento kings", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "new york rangers vs philadelphia flyers", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "detroit red wings vs washington capitals", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "chicago blackhawks vs ottawa senators", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "edmonton oilers vs minnesota wild", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "buffalo sabres vs new york islanders", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "florida panthers vs st. louis blues", url: "https://roxiestreams.live/nhl-streams-6"},
  {title: "boston bruins vs vancouver canucks", url: "https://roxiestreams.live/nhl-streams-7"},
  {title: "montreal canadiens vs pittsburgh penguins", url: "https://roxiestreams.live/nhl-streams-8"},
  {title: "carolina hurricanes vs tampa bay lightning", url: "https://roxiestreams.live/nhl-streams-9"},
  {title: "nashville predators vs toronto maple leafs", url: "https://roxiestreams.live/nhl-streams-10"},
  {title: "calgary flames vs vegas golden knights", url: "https://roxiestreams.live/nhl-streams-11"},
  {title: "anaheim ducks vs columbus blue jackets", url: "https://roxiestreams.live/nhl-streams-12"},
  {title: "san jose sharks vs seattle kraken", url: "https://roxiestreams.live/nhl-streams-13"},
  {title: "detroit red wings vs washington capitals", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "colorado avalanche vs minnesota wild", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "boston bruins vs ottawa senators", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "buffalo sabres vs new jersey devils", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "montreal canadiens vs pittsburgh penguins", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "nashville predators vs new york rangers", url: "https://roxiestreams.live/nhl-streams-6"},
  {title: "dallas stars vs toronto maple leafs", url: "https://roxiestreams.live/nhl-streams-7"},
  {title: "utah mammoth vs winnipeg jets", url: "https://roxiestreams.live/nhl-streams-8"},
  {title: "edmonton oilers vs vegas golden knights", url: "https://roxiestreams.live/nhl-streams-9"},
  {title: "kubota high limit racing - prelim night 1", url: "https://roxiestreams.live/floracing-1"},
  {title: "kubota high limit racing - prelim night 2", url: "https://roxiesWtreams.live/floracing-1"},
  {title: "kubota high limit racing - race", url: "https://roxiestreams.live/floracing-1"},
  {title: "pfl africa 4", url: "https://roxiestreams.live/ppv-streams-1"},
  {title: "chase demoor vs misfits mania: andrew tate", url: "https://roxiestreams.live/ppv-streams-2"},
  {title: "philadelphia eagles vs washington commanders", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "chicago bears vs green bay packers", url: "https://roxiestreams.live/nfl-streams-2"},
  {title: "miami (fl) vs texas a&m", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "ole miss vs tulane", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "james madison vs oregon", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "buffalo bills vs cleveland browns", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "dallas cowboys vs los angeles rams", url: "https://roxiestreams.live/nfl-streams-2"},
  {title: "kansas city chiefs vs tennessee titans", url: "https://roxiestreams.live/nfl-streams-3"},
  {title: "cincinnati bengals vs miami dolphins", url: "https://roxiestreams.live/nfl-streams-4"},
  {title: "new orleans saints vs new york", url: "https://roxiestreams.live/nfl-streams-5"},
  {title: "minnesota vikings vs new york", url: "https://roxiestreams.live/nfl-streams-6"},
  {title: "carolina panthers vs tampa bay buccaneers", url: "https://roxiestreams.live/nfl-streams-7"},
  {title: "denver broncos vs jacksonville jaguars", url: "https://roxiestreams.live/nfl-streams-8"},
  {title: "arizona cardinals vs atlanta falcons", url: "https://roxiestreams.live/nfl-streams-9"},
  {title: "detroit lions vs pittsburgh steelers", url: "https://roxiestreams.live/nfl-streams-10"},
  {title: "houston texans vs las vegas raiders", url: "https://roxiestreams.live/nfl-streams-11"},
  {title: "baltimore ravens vs new england patriots", url: "https://roxiestreams.live/nfl-streams-12"}
];

  const nbaTeams = new Set(["san antonio spurs","golden state warriors","memphis grizzlies","cleveland cavaliers","portland trail blazers","los angeles clippers","detroit pistons","miami heat","milwaukee bucks","new orleans pelicans","atlanta hawks","charlotte hornets","denver nuggets","orlando magic","phoenix suns","sacramento kings","washington wizards","oklahoma city thunder","new york knicks","boston celtics","dallas mavericks","utah jazz","philadelphia 76ers","toronto raptors","chicago bulls","indiana pacers","los angeles lakers","minnesota timberwolves","houston rockets"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.live/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.live/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.live/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.live/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.live/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.live/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
