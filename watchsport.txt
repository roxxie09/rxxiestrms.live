(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "aew": "aew",
  "anaheim ducks": "anaheim ducks",
  "atalanta": "atalanta",
  "atlético madrid": "atlético madrid",
  "barcelona": "barcelona",
  "bayern münchen": "bayern münchen",
  "birmingham city": "birmingham city",
  "boston bruins": "boston bruins",
  "buffalo sabres": "buffalo sabres",
  "calgary flames": "calgary flames",
  "carolina hurricanes": "carolina hurricanes",
  "chelsea": "chelsea",
  "colorado avalanche": "colorado avalanche",
  "columbus blue jackets": "columbus blue jackets",
  "dallas stars": "dallas stars",
  "detroit red wings": "detroit red wings",
  "edmonton oilers": "edmonton oilers",
  "eintracht frankfurt": "eintracht frankfurt",
  "galatasaray": "galatasaray",
  "indiana pacers": "indiana pacers",
  "inter milan": "inter milan",
  "kairat": "kairat",
  "kubota high limit racing - prelim night 1": "kubota high limit racing - prelim night 1",
  "kubota high limit racing - prelim night 2": "kubota high limit racing - prelim night 2",
  "kubota high limit racing - race": "kubota high limit racing - race",
  "liverpool": "liverpool",
  "los angeles chargers": "los angeles chargers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles kings": "los angeles kings",
  "marseille": "marseille",
  "miami heat": "miami heat",
  "minnesota timberwolves": "minnesota timberwolves",
  "minnesota wild": "minnesota wild",
  "monaco": "monaco",
  "montreal canadiens": "montreal canadiens",
  "nashville predators": "nashville predators",
  "new jersey devils": "new jersey devils",
  "new orleans pelicans": "new orleans pelicans",
  "new york islanders": "new york islanders",
  "new york knicks": "new york knicks",
  "olympiacos piraeus": "olympiacos piraeus",
  "orlando magic": "orlando magic",
  "ottawa senators": "ottawa senators",
  "philadelphia eagles": "philadelphia eagles",
  "philadelphia flyers": "philadelphia flyers",
  "phoenix suns": "phoenix suns",
  "pittsburgh penguins": "pittsburgh penguins",
  "psv": "psv",
  "queens park rangers": "queens park rangers",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "san jose sharks": "san jose sharks",
  "seattle kraken": "seattle kraken",
  "slavia praha": "slavia praha",
  "sporting cp": "sporting cp",
  "st. louis blues": "st. louis blues",
  "tampa bay lightning": "tampa bay lightning",
  "toronto blue jays": "toronto blue jays",
  "toronto maple leafs": "toronto maple leafs",
  "toronto raptors": "toronto raptors",
  "tottenham": "tottenham",
  "uefa golazo show": "uefa golazo show",
  "union saint-gilloise": "union saint-gilloise",
  "utah mammoth": "utah mammoth",
  "vancouver canucks": "vancouver canucks",
  "vegas golden knights": "vegas golden knights",
  "winnipeg jets": "winnipeg jets",
  "wwe nxt": "wwe nxt",
  "wwe raw": "wwe raw",
  "pacers": "indiana pacers",
  "heat": "miami heat",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "magic": "orlando magic",
  "suns": "phoenix suns",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors"
};

  const roxieStreamsCached = [
  {title: "kairat vs olympiacos piraeus", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "bayern münchen vs sporting cp", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "uefa golazo show", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "atalanta vs chelsea", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "barcelona vs eintracht frankfurt", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "inter milan vs liverpool", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "galatasaray vs monaco", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "atlético madrid vs psv", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "slavia praha vs tottenham", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "marseille vs union saint-gilloise", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "birmingham city vs queens park rangers", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "indiana pacers vs sacramento kings", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "minnesota timberwolves vs phoenix suns", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "new orleans pelicans vs san antonio spurs", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "miami heat vs orlando magic", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "new york knicks vs toronto raptors", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "tampa bay lightning vs toronto maple leafs", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "los angeles kings vs utah mammoth", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "buffalo sabres vs calgary flames", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "detroit red wings vs vancouver canucks", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "minnesota wild vs seattle kraken", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "montreal canadiens vs tampa bay lightning", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "new jersey devils vs ottawa senators", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "new york islanders vs vegas golden knights", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "philadelphia flyers vs san jose sharks", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "anaheim ducks vs pittsburgh penguins", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "carolina hurricanes vs columbus blue jackets", url: "https://roxiestreams.live/nhl-streams-6"},
  {title: "boston bruins vs st. louis blues", url: "https://roxiestreams.live/nhl-streams-7"},
  {title: "dallas stars vs winnipeg jets", url: "https://roxiestreams.live/nhl-streams-8"},
  {title: "buffalo sabres vs edmonton oilers", url: "https://roxiestreams.live/nhl-streams-9"},
  {title: "colorado avalanche vs nashville predators", url: "https://roxiestreams.live/nhl-streams-10"},
  {title: "kubota high limit racing - prelim night 1", url: "https://roxiestreams.live/floracing-1"},
  {title: "kubota high limit racing - prelim night 2", url: "https://roxiesWtreams.live/floracing-1"},
  {title: "kubota high limit racing - race", url: "https://roxiestreams.live/floracing-1"},
  {title: "wwe raw", url: "https://roxiestreams.live/wwe-streams"},
  {title: "wwe nxt", url: "https://roxiestreams.live/wwe-streams"},
  {title: "aew", url: "https://roxiestreams.live/aew"},
  {title: "los angeles chargers vs philadelphia eagles", url: "https://roxiestreams.live/nfl-streams-1"}
];

  const nbaTeams = new Set(["indiana pacers","sacramento kings","memphis grizzlies","new orleans pelicans","atlanta hawks","orlando magic","dallas mavericks","toronto raptors","phoenix suns","detroit pistons","golden state warriors","los angeles clippers","utah jazz","miami heat","oklahoma city thunder","minnesota timberwolves","milwaukee bucks","san antonio spurs","portland trail blazers","philadelphia 76ers","new york knicks","chicago bulls","denver nuggets","washington wizards","charlotte hornets","boston celtics","cleveland cavaliers","houston rockets","los angeles lakers"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.live/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.live/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.live/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.live/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.live/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.live/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
