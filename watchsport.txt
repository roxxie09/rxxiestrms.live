(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "alverca": "alverca",
  "anaheim ducks": "anaheim ducks",
  "arizona cardinals": "arizona cardinals",
  "athletic club": "athletic club",
  "atlanta falcons": "atlanta falcons",
  "atlanta hawks": "atlanta hawks",
  "baltimore ravens": "baltimore ravens",
  "benfica": "benfica",
  "bologna": "bologna",
  "boston bruins": "boston bruins",
  "boston celtics": "boston celtics",
  "brooklyn nets": "brooklyn nets",
  "buffalo bills": "buffalo bills",
  "buffalo sabres": "buffalo sabres",
  "carolina panthers": "carolina panthers",
  "charlotte hornets": "charlotte hornets",
  "chicago bulls": "chicago bulls",
  "cincinnati bengals": "cincinnati bengals",
  "cleveland browns": "cleveland browns",
  "cleveland cavaliers": "cleveland cavaliers",
  "colorado avalanche": "colorado avalanche",
  "columbus blue jackets": "columbus blue jackets",
  "dallas cowboys": "dallas cowboys",
  "dallas mavericks": "dallas mavericks",
  "dallas stars": "dallas stars",
  "denver broncos": "denver broncos",
  "denver nuggets": "denver nuggets",
  "detroit lions": "detroit lions",
  "detroit pistons": "detroit pistons",
  "detroit red wings": "detroit red wings",
  "edmonton oilers": "edmonton oilers",
  "espanyol": "espanyol",
  "famalicão": "famalicão",
  "fulham": "fulham",
  "golden state warriors": "golden state warriors",
  "houston rockets": "houston rockets",
  "houston texans": "houston texans",
  "indiana pacers": "indiana pacers",
  "indianapolis colts": "indianapolis colts",
  "jacksonville jaguars": "jacksonville jaguars",
  "kansas city chiefs": "kansas city chiefs",
  "kubota high limit racing - prelim night 1": "kubota high limit racing - prelim night 1",
  "kubota high limit racing - prelim night 2": "kubota high limit racing - prelim night 2",
  "kubota high limit racing - race": "kubota high limit racing - race",
  "las vegas raiders": "las vegas raiders",
  "los angeles chargers": "los angeles chargers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles kings": "los angeles kings",
  "memphis grizzlies": "memphis grizzlies",
  "miami dolphins": "miami dolphins",
  "miami heat": "miami heat",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota timberwolves": "minnesota timberwolves",
  "minnesota vikings": "minnesota vikings",
  "minnesota wild": "minnesota wild",
  "montreal canadiens": "montreal canadiens",
  "napoli": "napoli",
  "nashville predators": "nashville predators",
  "new england patriots": "new england patriots",
  "new jersey devils": "new jersey devils",
  "new orleans pelicans": "new orleans pelicans",
  "new orleans saints": "new orleans saints",
  "new york giants": "new york giants",
  "new york jets": "new york jets",
  "new york knicks": "new york knicks",
  "new york rangers": "new york rangers",
  "nfl redzone": "nfl redzone",
  "nottingham": "nottingham",
  "oklahoma city thunder": "oklahoma city thunder",
  "orlando magic": "orlando magic",
  "ottawa senators": "ottawa senators",
  "philadelphia flyers": "philadelphia flyers",
  "pittsburgh penguins": "pittsburgh penguins",
  "pittsburgh steelers": "pittsburgh steelers",
  "portland trail blazers": "portland trail blazers",
  "porto": "porto",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "san francisco 49ers": "san francisco 49ers",
  "seattle kraken": "seattle kraken",
  "st. louis blues": "st. louis blues",
  "tampa bay buccaneers": "tampa bay buccaneers",
  "tampa bay lightning": "tampa bay lightning",
  "tennessee titans": "tennessee titans",
  "toronto blue jays": "toronto blue jays",
  "toronto maple leafs": "toronto maple leafs",
  "toronto raptors": "toronto raptors",
  "utah jazz": "utah jazz",
  "utah mammoth": "utah mammoth",
  "vancouver canucks": "vancouver canucks",
  "vegas golden knights": "vegas golden knights",
  "washington capitals": "washington capitals",
  "washington wizards": "washington wizards",
  "winnipeg jets": "winnipeg jets",
  "wwe raw": "wwe raw",
  "hawks": "atlanta hawks",
  "celtics": "boston celtics",
  "hornets": "charlotte hornets",
  "bulls": "chicago bulls",
  "cavaliers": "cleveland cavaliers",
  "mavericks": "dallas mavericks",
  "nuggets": "denver nuggets",
  "pistons": "detroit pistons",
  "warriors": "golden state warriors",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "magic": "orlando magic",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors",
  "jazz": "utah jazz",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "alverca vs porto", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "bologna vs napoli", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "athletic club vs espanyol", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "fulham vs nottingham", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "benfica vs famalicão", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "atlanta hawks vs chicago bulls", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "brooklyn nets vs toronto raptors", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "miami heat vs new york knicks", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "san antonio spurs vs washington wizards", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "milwaukee bucks vs minnesota timberwolves", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "houston rockets vs sacramento kings", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "charlotte hornets vs cleveland cavaliers", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "boston celtics vs indiana pacers", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "dallas mavericks vs new orleans pelicans", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "denver nuggets vs utah jazz", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "memphis grizzlies vs oklahoma city thunder", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "golden state warriors vs orlando magic", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "detroit pistons vs portland trail blazers", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "detroit red wings vs washington capitals", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "colorado avalanche vs minnesota wild", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "boston bruins vs ottawa senators", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "buffalo sabres vs new jersey devils", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "montreal canadiens vs pittsburgh penguins", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "nashville predators vs new york rangers", url: "https://roxiestreams.live/nhl-streams-6"},
  {title: "dallas stars vs toronto maple leafs", url: "https://roxiestreams.live/nhl-streams-7"},
  {title: "utah mammoth vs winnipeg jets", url: "https://roxiestreams.live/nhl-streams-8"},
  {title: "edmonton oilers vs vegas golden knights", url: "https://roxiestreams.live/nhl-streams-9"},
  {title: "st. louis blues vs tampa bay lightning", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "philadelphia flyers vs vancouver canucks", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "anaheim ducks vs seattle kraken", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "columbus blue jackets vs los angeles kings", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "kubota high limit racing - prelim night 1", url: "https://roxiestreams.live/floracing-1"},
  {title: "kubota high limit racing - prelim night 2", url: "https://roxiesWtreams.live/floracing-1"},
  {title: "kubota high limit racing - race", url: "https://roxiestreams.live/floracing-1"},
  {title: "wwe raw", url: "https://roxiestreams.live/wwe-streams"},
  {title: "nfl redzone", url: "https://roxiestreams.live/redzone"},
  {title: "buffalo bills vs cleveland browns", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "dallas cowboys vs los angeles chargers", url: "https://roxiestreams.live/nfl-streams-2"},
  {title: "kansas city chiefs vs tennessee titans", url: "https://roxiestreams.live/nfl-streams-3"},
  {title: "cincinnati bengals vs miami dolphins", url: "https://roxiestreams.live/nfl-streams-4"},
  {title: "new orleans saints vs new york jets", url: "https://roxiestreams.live/nfl-streams-5"},
  {title: "minnesota vikings vs new york giants", url: "https://roxiestreams.live/nfl-streams-6"},
  {title: "carolina panthers vs tampa bay buccaneers", url: "https://roxiestreams.live/nfl-streams-7"},
  {title: "denver broncos vs jacksonville jaguars", url: "https://roxiestreams.live/nfl-streams-8"},
  {title: "arizona cardinals vs atlanta falcons", url: "https://roxiestreams.live/nfl-streams-9"},
  {title: "detroit lions vs pittsburgh steelers", url: "https://roxiestreams.live/nfl-streams-10"},
  {title: "houston texans vs las vegas raiders", url: "https://roxiestreams.live/nfl-streams-11"},
  {title: "baltimore ravens vs new england patriots", url: "https://roxiestreams.live/nfl-streams-12"},
  {title: "indianapolis colts vs san francisco 49ers", url: "https://roxiestreams.live/nfl-streams-1"}
];

  const nbaTeams = new Set(["denver nuggets","los angeles lakers","orlando magic","atlanta hawks","charlotte hornets","toronto raptors","portland trail blazers","minnesota timberwolves","indiana pacers","cleveland cavaliers","utah jazz","los angeles clippers","oklahoma city thunder","chicago bulls","phoenix suns","new orleans pelicans","dallas mavericks","new york knicks","philadelphia 76ers","houston rockets","memphis grizzlies","detroit pistons","golden state warriors","sacramento kings","san antonio spurs","boston celtics","milwaukee bucks","washington wizards","miami heat"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.live/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.live/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.live/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.live/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.live/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.live/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
