(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "2 de mayo": "2 de mayo",
  "aberdeen": "aberdeen",
  "aew": "aew",
  "argentinos juniors": "argentinos juniors",
  "arsenal": "arsenal",
  "atlético madrid": "atlético madrid",
  "bahia/a>": "bahia/a>",
  "barcelona": "barcelona",
  "bayer leverkusen": "bayer leverkusen",
  "bodø / glimt": "bodø / glimt",
  "cartaginés": "cartaginés",
  "cincinnati": "cincinnati",
  "ciudad bolivar": "ciudad bolivar",
  "club brugge": "club brugge",
  "como": "como",
  "defence force": "defence force",
  "formula 1 - pre season testing (day 1)": "formula 1 - pre season testing (day 1)",
  "formula 1 - pre season testing (day 2)": "formula 1 - pre season testing (day 2)",
  "formula 1 - pre season testing (day 3)": "formula 1 - pre season testing (day 3)",
  "inter milan": "inter milan",
  "lafc": "lafc",
  "levante": "levante",
  "milan": "milan",
  "motherwell": "motherwell",
  "nba all-star sunday": "nba all-star sunday",
  "newcastle": "newcastle",
  "o'higgins": "o'higgins",
  "olympiakos piraeus": "olympiakos piraeus",
  "philadelphia union": "philadelphia union",
  "qarabağ": "qarabağ",
  "real españa": "real españa",
  "river plate": "river plate",
  "sporting cristal": "sporting cristal",
  "universidad o&m": "universidad o&m",
  "vancouver whitecaps": "vancouver whitecaps",
  "villarreal": "villarreal",
  "wolves": "wolves",
  "wwe nxt": "wwe nxt",
  "wwe smackdown": "wwe smackdown"
};

  const roxieStreamsCached = [
  {title: "2 de mayo vs sporting cristal", url: "https://roxiestreams.info/soccer-streams-7"},
  {title: "ciudad bolivar vs river plate", url: "https://roxiestreams.info/soccer-streams-8"},
  {title: "lafc vs real españa", url: "https://roxiestreams.info/soccer-streams-9"},
  {title: "newcastle vs qarabağ", url: "https://roxiestreams.info/soccer-streams-1"},
  {title: "levante vs villarreal", url: "https://roxiestreams.info/soccer-streams-2"},
  {title: "aberdeen vs motherwell", url: "https://roxiestreams.info/soccer-streams-3"},
  {title: "como vs milan", url: "https://roxiestreams.info/soccer-streams-4"},
  {title: "arsenal vs wolves", url: "https://roxiestreams.info/soccer-streams-5"},
  {title: "bodø / glimt vs inter milan", url: "https://roxiestreams.info/soccer-streams-6"},
  {title: "atlético madrid vs club brugge", url: "https://roxiestreams.info/soccer-streams-7"},
  {title: "bayer leverkusen vs olympiakos piraeus", url: "https://roxiestreams.info/soccer-streams-8"},
  {title: "bahia/a> vs o'higgins", url: "https://roxiestreams.info/soccer-streams-9"},
  {title: "defence force vs philadelphia union", url: "https://roxiestreams.info/soccer-streams-10"},
  {title: "argentinos juniors vs barcelona", url: "https://roxiestreams.info/soccer-streams-9"},
  {title: "cincinnati vs universidad o&m", url: "https://roxiestreams.info/soccer-streams-10"},
  {title: "cartaginés vs vancouver whitecaps", url: "https://roxiestreams.info/soccer-streams-11"},
  {title: "nba all-star sunday", url: "https://roxiestreams.info/nba-streams-1"},
  {title: "formula 1 - pre season testing (day 1)", url: "https://roxiestreams.info/f1"},
  {title: "formula 1 - pre season testing (day 2)", url: "https://roxiestreams.info/f1"},
  {title: "formula 1 - pre season testing (day 3)", url: "https://roxiestreams.info/f1"},
  {title: "wwe nxt", url: "https://roxiestreams.info/wwe-streams"},
  {title: "aew", url: "https://roxiestreams.info/aew"},
  {title: "wwe smackdown", url: "https://roxiestreams.info/wwe-streams"}
];

  const nbaTeams = new Set(["portland trail blazers","new york knicks","sacramento kings","minnesota timberwolves","milwaukee bucks","los angeles lakers","miami heat","golden state warriors","boston celtics","los angeles clippers","atlanta hawks","denver nuggets","memphis grizzlies","indiana pacers","chicago bulls","san antonio spurs","washington wizards","cleveland cavaliers","orlando magic","houston rockets","charlotte hornets","detroit pistons","oklahoma city thunder","dallas mavericks","toronto raptors","new orleans pelicans","phoenix suns","utah jazz","philadelphia 76ers"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

  function normalizeTeamName(name) {
    return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
  }

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

  const normalizedCache = roxieStreamsCached.map(item => ({ 
    title: normalizeTitle(item.title),
    url: item.url
  }));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.info/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.info/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.info/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.info/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.info/missing';
  }

  function getEventTitleFromGameItem(gameItem) {
    if (!gameItem) return '';
    const matchupDiv = gameItem.querySelector('.game-matchup');
    if (!matchupDiv) return '';
    return matchupDiv.textContent.trim();
  }

  function getLeagueFromGameItem(gameItem) {
    const broadcastDiv = gameItem.querySelector('.game-broadcast');
    return broadcastDiv ? broadcastDiv.textContent.trim() : '';
  }

  function autofillHandler(e) {
    const button = e.currentTarget;
    const gameId = button.getAttribute('data-modal');
    const gameItem = button.closest('.game-item');

    const eventTitle = getEventTitleFromGameItem(gameItem);
    const leagueText = getLeagueFromGameItem(gameItem);
    console.log('Extracted event title:', eventTitle, 'league:', leagueText, 'gameId:', gameId);

    let channelName = '';

    const lowerTitle = eventTitle.toLowerCase();

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => lowerTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (lowerTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (lowerTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (lowerTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => lowerTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => lowerTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => lowerTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const modal = document.getElementById(`modal-${gameId}`);
      if (!modal) {
        console.warn('Modal not found for gameId:', gameId);
        return;
      }

      const form = modal.querySelector('form.stream-form');
      if (!form) {
        console.warn('Form not found in modal for gameId:', gameId);
        return;
      }

      const streamUrl = findBestMatch(eventTitle);

      const siteInput = form.querySelector('input[name="site"]');
      const urlInput = form.querySelector('input[name="url"]');
      const channelInput = form.querySelector('input[name="channel"]');
      const bitrateInput = form.querySelector('input[name="bitrate"]');
      const adsSelect = form.querySelector('select[name="ads"]');
      const fpsSelect = form.querySelector('select[name="fps"]');

      if (siteInput) siteInput.value = 'RoxieStreams';
      if (urlInput) urlInput.value = streamUrl;
      if (channelInput) channelInput.value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      if (bitrateInput) bitrateInput.value = '7000';
      if (adsSelect) adsSelect.value = '0';
      if (fpsSelect) fpsSelect.value = '60';

      form.querySelectorAll('input[type="checkbox"][name="Compatibility"]').forEach(cb => {
        cb.checked = true;
      });

      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0 for gameId ${gameId}`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add-btn').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add-btn'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-modal');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300));

      const modal = document.getElementById(`modal-${gameId}`);
      if (!modal) {
        console.warn(`Modal not found for gameId: ${gameId}`);
        continue;
      }
      const form = modal.querySelector('form.stream-form');
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }

      const urlInput = form.querySelector('input[name="url"]');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }

      const urlValue = urlInput.value.trim();

      if (urlValue === 'https://roxiestreams.info/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      const submitBtn = form.querySelector('button.submit-btn[type="submit"]');
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked submit button for ${gameId}`);
      } else {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }

      await new Promise(res => setTimeout(res, 300));
    }
  }

  autoProcessAllEvents();

  window.autoProcessAllEvents = autoProcessAllEvents;
})();
