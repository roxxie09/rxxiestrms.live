(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "anaheim ducks": "anaheim ducks",
  "antalyaspor": "antalyaspor",
  "arizona cardinals": "arizona cardinals",
  "army": "army",
  "arsenal": "arsenal",
  "atlanta hawks": "atlanta hawks",
  "atletico madrid": "atletico madrid",
  "augsburg": "augsburg",
  "baltimore ravens": "baltimore ravens",
  "barcelona": "barcelona",
  "bayer leverkusen": "bayer leverkusen",
  "boise state v washington": "boise state v washington",
  "boston bruins": "boston bruins",
  "brighton": "brighton",
  "bristol city": "bristol city",
  "brooklyn nets": "brooklyn nets",
  "buffalo bills": "buffalo bills",
  "buffalo sabres": "buffalo sabres",
  "burnley": "burnley",
  "calgary flames": "calgary flames",
  "carolina hurricanes": "carolina hurricanes",
  "carolina panthers": "carolina panthers",
  "charlotte hornets": "charlotte hornets",
  "chelsea": "chelsea",
  "chicago bears": "chicago bears",
  "chicago blackhawks": "chicago blackhawks",
  "chicago bulls": "chicago bulls",
  "cincinnati bengals": "cincinnati bengals",
  "cleveland browns": "cleveland browns",
  "cleveland cavaliers": "cleveland cavaliers",
  "colorado avalanche": "colorado avalanche",
  "columbus blue jackets": "columbus blue jackets",
  "coventry city": "coventry city",
  "dallas cowboys": "dallas cowboys",
  "dallas stars": "dallas stars",
  "denver broncos": "denver broncos",
  "detroit lions": "detroit lions",
  "detroit red wings": "detroit red wings",
  "east": "east",
  "edmonton oilers": "edmonton oilers",
  "eintracht frankfurt": "eintracht frankfurt",
  "elche": "elche",
  "espanyol": "espanyol",
  "everton": "everton",
  "flamengo": "flamengo",
  "florida panthers": "florida panthers",
  "fulham": "fulham",
  "galatasaray": "galatasaray",
  "getafe": "getafe",
  "golden state warriors": "golden state warriors",
  "green bay packers": "green bay packers",
  "houston texans": "houston texans",
  "indiana pacers": "indiana pacers",
  "indianapolis colts": "indianapolis colts",
  "jack": "jack",
  "jacksonville jaguars": "jacksonville jaguars",
  "kansas city chiefs": "kansas city chiefs",
  "kape": "kape",
  "kubota high limit racing - prelim night 1": "kubota high limit racing - prelim night 1",
  "kubota high limit racing - prelim night 2": "kubota high limit racing - prelim night 2",
  "kubota high limit racing - race": "kubota high limit racing - race",
  "köln": "köln",
  "las vegas raiders": "las vegas raiders",
  "liverpool": "liverpool",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles kings": "los angeles kings",
  "los angeles lakers": "los angeles lakers",
  "los angeles rams": "los angeles rams",
  "mallorca": "mallorca",
  "mansfield town": "mansfield town",
  "metz": "metz",
  "mikaelian": "mikaelian",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota timberwolves": "minnesota timberwolves",
  "minnesota vikings": "minnesota vikings",
  "minnesota wild": "minnesota wild",
  "montreal canadiens": "montreal canadiens",
  "nashville predators": "nashville predators",
  "navy": "navy",
  "new england patriots": "new england patriots",
  "new jersey devils": "new jersey devils",
  "new orleans pelicans": "new orleans pelicans",
  "new orleans saints": "new orleans saints",
  "new york": "new york",
  "new york islanders": "new york islanders",
  "new york knicks": "new york knicks",
  "new york rangers": "new york rangers",
  "oklahoma city thunder": "oklahoma city thunder",
  "orlando magic": "orlando magic",
  "osasuna": "osasuna",
  "ottawa senators": "ottawa senators",
  "paris": "paris",
  "philadelphia 76ers": "philadelphia 76ers",
  "philadelphia eagles": "philadelphia eagles",
  "philadelphia flyers": "philadelphia flyers",
  "phoenix suns": "phoenix suns",
  "pittsburgh penguins": "pittsburgh penguins",
  "portland trail blazers": "portland trail blazers",
  "prairie view a&m": "prairie view a&m",
  "psg": "psg",
  "pyramids fc": "pyramids fc",
  "redneck brawl 11": "redneck brawl 11",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "san francisco 49ers": "san francisco 49ers",
  "san jose sharks": "san jose sharks",
  "seattle kraken": "seattle kraken",
  "seattle seahawks": "seattle seahawks",
  "south carolina state": "south carolina state",
  "south dakota v montana": "south dakota v montana",
  "stoke city": "stoke city",
  "swansea city": "swansea city",
  "tampa bay lightning": "tampa bay lightning",
  "tennessee titans": "tennessee titans",
  "toronto blue jays": "toronto blue jays",
  "toronto maple leafs": "toronto maple leafs",
  "toulouse": "toulouse",
  "ufc fight night: royval": "ufc fight night: royval",
  "utah mammoth": "utah mammoth",
  "valencia": "valencia",
  "vancouver canucks": "vancouver canucks",
  "vegas golden knights": "vegas golden knights",
  "villanova v tarleton state": "villanova v tarleton state",
  "washington capitals": "washington capitals",
  "washington commanders": "washington commanders",
  "washington wizards": "washington wizards",
  "west 21": "west 21",
  "wimbledon": "wimbledon",
  "winnipeg jets": "winnipeg jets",
  "wolves": "wolves",
  "wwe saturday night main event": "wwe saturday night main event",
  "hawks": "atlanta hawks",
  "hornets": "charlotte hornets",
  "bulls": "chicago bulls",
  "cavaliers": "cleveland cavaliers",
  "warriors": "golden state warriors",
  "pacers": "indiana pacers",
  "lakers": "los angeles lakers",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "magic": "orlando magic",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "mansfield town vs wimbledon", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "stoke city vs swansea city", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "atletico madrid vs valencia", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "augsburg vs eintracht frankfurt", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "chelsea vs everton", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "brighton vs liverpool", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "bristol city vs coventry city", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "elche vs mallorca", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "flamengo vs pyramids fc", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "antalyaspor vs galatasaray", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "burnley vs fulham", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "barcelona vs osasuna", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "bayer leverkusen vs köln", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "metz vs psg", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "espanyol vs getafe", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "arsenal vs wolves", url: "https://roxiestreams.live/soccer-streams-12"},
  {title: "paris vs toulouse", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "new york knicks vs orlando magic", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "oklahoma city thunder vs san antonio spurs", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "indiana pacers vs washington wizards", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "charlotte hornets vs cleveland cavaliers", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "atlanta hawks vs philadelphia 76ers", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "brooklyn nets vs milwaukee bucks", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "minnesota timberwolves vs sacramento kings", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "chicago bulls vs new orleans pelicans", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "los angeles lakers vs phoenix suns", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "golden state warriors vs portland trail blazers", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "anaheim ducks vs new jersey devils", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "minnesota wild vs ottawa senators", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "pittsburgh penguins vs san jose sharks", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "new york islanders vs tampa bay lightning", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "edmonton oilers vs toronto maple leafs", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "montreal canadiens vs new york rangers", url: "https://roxiestreams.live/nhl-streams-6"},
  {title: "carolina hurricanes vs philadelphia flyers", url: "https://roxiestreams.live/nhl-streams-7"},
  {title: "columbus blue jackets vs vegas golden knights", url: "https://roxiestreams.live/nhl-streams-8"},
  {title: "washington capitals vs winnipeg jets", url: "https://roxiestreams.live/nhl-streams-9"},
  {title: "chicago blackhawks vs detroit red wings", url: "https://roxiestreams.live/nhl-streams-10"},
  {title: "dallas stars vs florida panthers", url: "https://roxiestreams.live/nhl-streams-11"},
  {title: "colorado avalanche vs nashville predators", url: "https://roxiestreams.live/nhl-streams-12"},
  {title: "calgary flames vs los angeles kings", url: "https://roxiestreams.live/nhl-streams-13"},
  {title: "new jersey devils vs vancouver canucks", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "pittsburgh penguins vs utah mammoth", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "carolina hurricanes vs philadelphia flyers", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "boston bruins vs minnesota wild", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "edmonton oilers vs montreal canadiens", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "buffalo sabres vs seattle kraken", url: "https://roxiestreams.live/nhl-streams-6"},
  {title: "kubota high limit racing - prelim night 1", url: "https://roxiestreams.live/floracing-1"},
  {title: "kubota high limit racing - prelim night 2", url: "https://roxiesWtreams.live/floracing-1"},
  {title: "kubota high limit racing - race", url: "https://roxiestreams.live/floracing-1"},
  {title: "east vs west 21", url: "https://roxiestreams.live/ppv-streams-3"},
  {title: "jack vs mikaelian", url: "https://roxiestreams.live/ppv-streams-1"},
  {title: "kape vs ufc fight night: royval", url: "https://roxiestreams.live/ufc"},
  {title: "redneck brawl 11", url: "https://roxiestreams.live/ppv-streams-2"},
  {title: "wwe saturday night main event", url: "https://roxiestreams.live/wwe-streams"},
  {title: "prairie view a&m vs south carolina state", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "villanova v tarleton state", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "army vs navy", url: "https://roxiestreams.live/ncaa-streams-3"},
  {title: "south dakota v montana", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "boise state v washington", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "chicago bears vs cleveland browns", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "baltimore ravens vs cincinnati bengals", url: "https://roxiestreams.live/nfl-streams-2"},
  {title: "kansas city chiefs vs los angeles rams", url: "https://roxiestreams.live/nfl-streams-3"},
  {title: "buffalo bills vs new england patriots", url: "https://roxiestreams.live/nfl-streams-4"},
  {title: "new york vs washington commanders", url: "https://roxiestreams.live/nfl-streams-5"},
  {title: "las vegas raiders vs philadelphia eagles", url: "https://roxiestreams.live/nfl-streams-6"},
  {title: "jacksonville jaguars vs new york", url: "https://roxiestreams.live/nfl-streams-7"},
  {title: "arizona cardinals vs houston texans", url: "https://roxiestreams.live/nfl-streams-8"},
  {title: "denver broncos vs green bay packers", url: "https://roxiestreams.live/nfl-streams-9"},
  {title: "detroit lions vs los angeles rams", url: "https://roxiestreams.live/nfl-streams-10"},
  {title: "carolina panthers vs new orleans saints", url: "https://roxiestreams.live/nfl-streams-11"},
  {title: "san francisco 49ers vs tennessee titans", url: "https://roxiestreams.live/nfl-streams-12"},
  {title: "indianapolis colts vs seattle seahawks", url: "https://roxiestreams.live/nfl-streams-13"},
  {title: "dallas cowboys vs minnesota vikings", url: "https://roxiestreams.live/nfl-streams-14"}
];

  const nbaTeams = new Set(["indiana pacers","sacramento kings","charlotte hornets","new orleans pelicans","toronto raptors","houston rockets","los angeles clippers","detroit pistons","new york knicks","orlando magic","portland trail blazers","washington wizards","golden state warriors","phoenix suns","milwaukee bucks","boston celtics","cleveland cavaliers","miami heat","los angeles lakers","atlanta hawks","minnesota timberwolves","philadelphia 76ers","utah jazz","san antonio spurs","memphis grizzlies","chicago bulls","oklahoma city thunder","dallas mavericks","denver nuggets"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.live/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.live/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.live/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.live/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.live/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.live/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
