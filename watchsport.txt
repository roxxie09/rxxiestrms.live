(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "aberdeen": "aberdeen",
  "aew": "aew",
  "aston villa": "aston villa",
  "baltimore ravens": "baltimore ravens",
  "boston celtics": "boston celtics",
  "carolina panthers": "carolina panthers",
  "celtic": "celtic",
  "charlotte hornets": "charlotte hornets",
  "cincinnati bengals": "cincinnati bengals",
  "cruz azul": "cruz azul",
  "crystal palace": "crystal palace",
  "dallas cowboys": "dallas cowboys",
  "detroit lions": "detroit lions",
  "detroit pistons": "detroit pistons",
  "feyenoord": "feyenoord",
  "fluminense": "fluminense",
  "formula 1 - las vegas grand prix": "formula 1 - las vegas grand prix",
  "golden state warriors": "golden state warriors",
  "green bay packers": "green bay packers",
  "guadalajara": "guadalajara",
  "houston rockets": "houston rockets",
  "indiana pacers": "indiana pacers",
  "kansas city chiefs": "kansas city chiefs",
  "los angeles dodgers": "los angeles dodgers",
  "lyon": "lyon",
  "maccabi tel aviv": "maccabi tel aviv",
  "malmö ff": "malmö ff",
  "memphis grizzlies": "memphis grizzlies",
  "miami heat": "miami heat",
  "midtjylland": "midtjylland",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota timberwolves": "minnesota timberwolves",
  "new orleans pelicans": "new orleans pelicans",
  "new york knicks": "new york knicks",
  "nice": "nice",
  "noah": "noah",
  "nottingham forest": "nottingham forest",
  "oklahoma city thunder": "oklahoma city thunder",
  "phoenix suns": "phoenix suns",
  "portland trail blazers": "portland trail blazers",
  "porto": "porto",
  "rangers": "rangers",
  "rayo vallecano": "rayo vallecano",
  "roma": "roma",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "san francisco 49ers": "san francisco 49ers",
  "shakhtar donetsk": "shakhtar donetsk",
  "shamrock rovers": "shamrock rovers",
  "slovan bratislava": "slovan bratislava",
  "sporting braga": "sporting braga",
  "strasbourg": "strasbourg",
  "são paulo": "são paulo",
  "toronto blue jays": "toronto blue jays",
  "toronto raptors": "toronto raptors",
  "young boys": "young boys",
  "celtics": "boston celtics",
  "hornets": "charlotte hornets",
  "pistons": "detroit pistons",
  "warriors": "golden state warriors",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "suns": "phoenix suns",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors"
};

  const roxieStreamsCached = [
  {title: "aston villa vs young boys", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "celtic vs feyenoord", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "midtjylland vs roma", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "rayo vallecano vs slovan bratislava", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "nice vs porto", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "aberdeen vs noah", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "crystal palace vs strasbourg", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "shakhtar donetsk vs shamrock rovers", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "rangers vs sporting braga", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "malmö ff vs nottingham forest", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "lyon vs maccabi tel aviv", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "fluminense vs são paulo", url: "https://roxiestreams.live/soccer-streams-12"},
  {title: "cruz azul vs guadalajara", url: "https://roxiestreams.live/soccer-streams-13"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "boston celtics vs detroit pistons", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "charlotte hornets vs new york knicks", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "miami heat vs milwaukee bucks", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "indiana pacers vs toronto raptors", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "minnesota timberwolves vs oklahoma city thunder", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "memphis grizzlies vs new orleans pelicans", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "golden state warriors vs houston rockets", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "portland trail blazers vs san antonio spurs", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "phoenix suns vs sacramento kings", url: "https://roxiestreams.live/nba-streams-9"},
  {title: "formula 1 - las vegas grand prix", url: "https://roxiestreams.live/f1-streams"},
  {title: "aew", url: "https://roxiestreams.live/aew"},
  {title: "carolina panthers vs san francisco 49ers", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "detroit lions vs green bay packers", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "dallas cowboys vs kansas city chiefs", url: "https://roxiestreams.live/nfl-streams-2"},
  {title: "baltimore ravens vs cincinnati bengals", url: "https://roxiestreams.live/nfl-streams-3"}
];

  const nbaTeams = new Set(["denver nuggets","new orleans pelicans","phoenix suns","oklahoma city thunder","philadelphia 76ers","dallas mavericks","milwaukee bucks","los angeles lakers","sacramento kings","atlanta hawks","detroit pistons","utah jazz","chicago bulls","houston rockets","san antonio spurs","boston celtics","portland trail blazers","minnesota timberwolves","memphis grizzlies","washington wizards","orlando magic","new york knicks","los angeles clippers","miami heat","charlotte hornets","cleveland cavaliers","toronto raptors","golden state warriors","indiana pacers"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.cc/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.cc/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.cc/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.cc/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.cc/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 400)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.cc/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 400));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 400));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
