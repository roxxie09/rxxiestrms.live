(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "américa": "américa",
  "arkansas": "arkansas",
  "athletic club": "athletic club",
  "atlanta hawks": "atlanta hawks",
  "atlético madrid": "atlético madrid",
  "auxerre": "auxerre",
  "ball state": "ball state",
  "barcelona": "barcelona",
  "bayer leverkusen": "bayer leverkusen",
  "bayern münchen": "bayern münchen",
  "baylor": "baylor",
  "benfica": "benfica",
  "boston celtics": "boston celtics",
  "boston college": "boston college",
  "bournemouth": "bournemouth",
  "brentford": "brentford",
  "brooklyn nets": "brooklyn nets",
  "burnley": "burnley",
  "byu": "byu",
  "cagliari": "cagliari",
  "ceará": "ceará",
  "charlotte hornets": "charlotte hornets",
  "chicago bulls": "chicago bulls",
  "cincinnati": "cincinnati",
  "clemson": "clemson",
  "cleveland cavaliers": "cleveland cavaliers",
  "colorado": "colorado",
  "cruzeiro": "cruzeiro",
  "dallas mavericks": "dallas mavericks",
  "denver nuggets": "denver nuggets",
  "deportivo alavés": "deportivo alavés",
  "detroit pistons": "detroit pistons",
  "dortmund": "dortmund",
  "duke": "duke",
  "everton": "everton",
  "fim supercross - australian gp": "fim supercross - australian gp",
  "flamengo": "flamengo",
  "formula 1 - qualifying": "formula 1 - qualifying",
  "formula 1 - sprint": "formula 1 - sprint",
  "fulham": "fulham",
  "golden state warriors": "golden state warriors",
  "houston": "houston",
  "indiana pacers": "indiana pacers",
  "inter miami": "inter miami",
  "iowa state": "iowa state",
  "juventus": "juventus",
  "juárez": "juárez",
  "kansas state": "kansas state",
  "kentucky": "kentucky",
  "lazio": "lazio",
  "leeds united": "leeds united",
  "leicester city": "leicester city",
  "levante": "levante",
  "los angeles clippers": "los angeles clippers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles lakers": "los angeles lakers",
  "louisville": "louisville",
  "lsu": "lsu",
  "mallorca": "mallorca",
  "manchester city": "manchester city",
  "marseille": "marseille",
  "memphis grizzlies": "memphis grizzlies",
  "miami (fl)": "miami (fl)",
  "miami (ohio)": "miami (ohio)",
  "miami heat": "miami heat",
  "milan": "milan",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota": "minnesota",
  "minnesota timberwolves": "minnesota timberwolves",
  "mirassol": "mirassol",
  "missouri": "missouri",
  "monaco": "monaco",
  "monterrey": "monterrey",
  "nacional": "nacional",
  "new orleans pelicans": "new orleans pelicans",
  "new york city": "new york city",
  "new york knicks": "new york knicks",
  "newcastle": "newcastle",
  "november 29, 2025 12:00 pm": "november 29, 2025 12:00 pm",
  "oklahoma": "oklahoma",
  "oklahoma city thunder": "oklahoma city thunder",
  "oklahoma state": "oklahoma state",
  "oregon": "oregon",
  "orlando magic": "orlando magic",
  "osasuna": "osasuna",
  "palmeiras": "palmeiras",
  "paris": "paris",
  "penn state": "penn state",
  "philadelphia 76ers": "philadelphia 76ers",
  "phoenix suns": "phoenix suns",
  "pitt": "pitt",
  "psg": "psg",
  "real oviedo": "real oviedo",
  "rutgers": "rutgers",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "san diego": "san diego",
  "sheffield united": "sheffield united",
  "south carolina": "south carolina",
  "st. pauli": "st. pauli",
  "sunderland": "sunderland",
  "swansea city": "swansea city",
  "syracuse": "syracuse",
  "tcu": "tcu",
  "tennessee": "tennessee",
  "texas tech": "texas tech",
  "tigres uanl": "tigres uanl",
  "tijuana": "tijuana",
  "toluca": "toluca",
  "toronto blue jays": "toronto blue jays",
  "toronto raptors": "toronto raptors",
  "tottenham hotspur": "tottenham hotspur",
  "toulouse": "toulouse",
  "ucf": "ucf",
  "utah jazz": "utah jazz",
  "vancouver whitecaps": "vancouver whitecaps",
  "vanderbilt": "vanderbilt",
  "vitória": "vitória",
  "wake forest": "wake forest",
  "washington": "washington",
  "washington wizards": "washington wizards",
  "west bromwich albion": "west bromwich albion",
  "west virginia": "west virginia",
  "wisconsin": "wisconsin",
  "wwe smackdown": "wwe smackdown",
  "hawks": "atlanta hawks",
  "celtics": "boston celtics",
  "hornets": "charlotte hornets",
  "bulls": "chicago bulls",
  "cavaliers": "cleveland cavaliers",
  "mavericks": "dallas mavericks",
  "nuggets": "denver nuggets",
  "pistons": "detroit pistons",
  "warriors": "golden state warriors",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "lakers": "los angeles lakers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "magic": "orlando magic",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors",
  "jazz": "utah jazz",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "leicester city vs sheffield united", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "mallorca vs osasuna", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "bayern münchen vs st. pauli", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "brentford vs burnley", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "leeds united vs manchester city", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "bournemouth vs sunderland", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "swansea city vs west bromwich albion", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "barcelona vs deportivo alavés", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "monaco vs psg", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "cagliari vs juventus", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "everton vs newcastle", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "athletic club vs levante", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "bayer leverkusen vs dortmund", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "benfica vs nacional", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "auxerre vs paris", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "mirassol vs vitória", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "lazio vs milan", url: "https://roxiestreams.live/soccer-streams-12"},
  {title: "atlético madrid vs real oviedo", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "fulham vs tottenham hotspur", url: "https://roxiestreams.live/soccer-streams-13"},
  {title: "marseille vs toulouse", url: "https://roxiestreams.live/soccer-streams-14"},
  {title: "flamengo vs palmeiras", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "inter miami vs new york city", url: "https://roxiestreams.live/soccer-streams-15"},
  {title: "américa vs monterrey", url: "https://roxiestreams.live/soccer-streams-16"},
  {title: "ceará vs cruzeiro", url: "https://roxiestreams.live/soccer-streams-17"},
  {title: "juárez vs toluca", url: "https://roxiestreams.live/soccer-streams-16"},
  {title: "san diego vs vancouver whitecaps", url: "https://roxiestreams.live/soccer-streams-18"},
  {title: "tigres uanl vs tijuana", url: "https://roxiestreams.live/soccer-streams-19"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "atlanta hawks vs cleveland cavaliers", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "brooklyn nets vs philadelphia 76ers", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "charlotte hornets vs chicago bulls", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "detroit pistons vs orlando magic", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "indiana pacers vs washington wizards", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "milwaukee bucks vs new york knicks", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "oklahoma city thunder vs phoenix suns", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "denver nuggets vs san antonio spurs", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "sacramento kings vs utah jazz", url: "https://roxiestreams.live/nba-streams-9"},
  {title: "dallas mavericks vs los angeles lakers", url: "https://roxiestreams.live/nba-streams-10"},
  {title: "los angeles clippers vs memphis grizzlies", url: "https://roxiestreams.live/nba-streams-11"},
  {title: "boston celtics vs minnesota timberwolves", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "charlotte hornets vs toronto raptors", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "chicago bulls vs indiana pacers", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "detroit pistons vs miami heat", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "brooklyn nets vs milwaukee bucks", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "golden state warriors vs new orleans pelicans", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "denver nuggets vs phoenix suns", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "dallas mavericks vs los angeles clippers", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "fim supercross - australian gp", url: "https://roxiestreams.live/supercross"},
  {title: "formula 1 - sprint", url: "https://roxiestreams.live/f1-streams"},
  {title: "formula 1 - qualifying", url: "https://roxiestreams.live/f1-streams"},
  {title: "wwe smackdown", url: "https://roxiestreams.live/wwe-streams"},
  {title: "november 29, 2025 12:00 pm", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "texas tech vs west virginia", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "miami (fl) vs pitt", url: "https://roxiestreams.live/ncaa-streams-3"},
  {title: "baylor vs houston", url: "https://roxiestreams.live/ncaa-streams-4"},
  {title: "colorado vs kansas state", url: "https://roxiestreams.live/ncaa-streams-5"},
  {title: "ball state vs miami (ohio)", url: "https://roxiestreams.live/ncaa-streams-6"},
  {title: "clemson vs south carolina", url: "https://roxiestreams.live/ncaa-streams-7"},
  {title: "iowa state vs oklahoma state", url: "https://roxiestreams.live/ncaa-streams-8"},
  {title: "kentucky vs louisville", url: "https://roxiestreams.live/ncaa-streams-9"},
  {title: "byu vs ucf", url: "https://roxiestreams.live/ncaa-streams-10"},
  {title: "boston college vs syracuse", url: "https://roxiestreams.live/ncaa-streams-11"},
  {title: "arkansas vs missouri", url: "https://roxiestreams.live/ncaa-streams-7"},
  {title: "cincinnati vs tcu", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "minnesota vs wisconsin", url: "https://roxiestreams.live/ncaa-streams-5"},
  {title: "tennessee vs vanderbilt", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "penn state vs rutgers", url: "https://roxiestreams.live/ncaa-streams-12"},
  {title: "duke vs wake forest", url: "https://roxiestreams.live/ncaa-streams-9"},
  {title: "lsu vs oklahoma", url: "https://roxiestreams.live/ncaa-streams-3"},
  {title: "oregon vs washington", url: "https://roxiestreams.live/ncaa-streams-13"}
];

  const nbaTeams = new Set(["oklahoma city thunder","minnesota timberwolves","phoenix suns","chicago bulls","miami heat","memphis grizzlies","boston celtics","utah jazz","milwaukee bucks","atlanta hawks","new orleans pelicans","new york knicks","toronto raptors","denver nuggets","cleveland cavaliers","philadelphia 76ers","sacramento kings","golden state warriors","charlotte hornets","detroit pistons","san antonio spurs","indiana pacers","orlando magic","portland trail blazers","los angeles lakers","washington wizards","houston rockets","los angeles clippers","dallas mavericks"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.cc/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.cc/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.cc/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.cc/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.cc/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.cc/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
