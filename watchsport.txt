(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "alabama": "alabama",
  "arsenal": "arsenal",
  "aston villa": "aston villa",
  "atalanta": "atalanta",
  "athletic club": "athletic club",
  "atlanta hawks": "atlanta hawks",
  "atlético madrid": "atlético madrid",
  "barcelona": "barcelona",
  "bayern münchen": "bayern münchen",
  "boise state": "boise state",
  "boston celtics": "boston celtics",
  "bournemouth": "bournemouth",
  "brentford": "brentford",
  "bristol city": "bristol city",
  "brooklyn nets": "brooklyn nets",
  "burnley": "burnley",
  "byu": "byu",
  "charlotte hornets": "charlotte hornets",
  "chelsea": "chelsea",
  "chicago bulls": "chicago bulls",
  "cleveland cavaliers": "cleveland cavaliers",
  "como": "como",
  "coventry city": "coventry city",
  "cruz azul": "cruz azul",
  "dallas mavericks": "dallas mavericks",
  "denver nuggets": "denver nuggets",
  "deportivo alavés": "deportivo alavés",
  "derby county": "derby county",
  "detroit pistons": "detroit pistons",
  "duke": "duke",
  "eintracht frankfurt": "eintracht frankfurt",
  "everton": "everton",
  "fim supercross championship": "fim supercross championship",
  "flamengo": "flamengo",
  "formula 1 - abu dhabi grand prix": "formula 1 - abu dhabi grand prix",
  "formula 1 - free practice": "formula 1 - free practice",
  "formula 1 - free practice 2": "formula 1 - free practice 2",
  "formula 1 - free practice 3": "formula 1 - free practice 3",
  "formula 1 - qualifying": "formula 1 - qualifying",
  "formula e - sao paulo race": "formula e - sao paulo race",
  "georgia": "georgia",
  "getafe": "getafe",
  "golden state warriors": "golden state warriors",
  "hellas verona": "hellas verona",
  "houston rockets": "houston rockets",
  "indiana": "indiana",
  "indiana pacers": "indiana pacers",
  "inter miami": "inter miami",
  "inter milan": "inter milan",
  "ipswich town": "ipswich town",
  "jackson state": "jackson state",
  "jacksonville state": "jacksonville state",
  "james madison": "james madison",
  "kennesaw state": "kennesaw state",
  "kilmarnock": "kilmarnock",
  "leeds": "leeds",
  "leicester city": "leicester city",
  "lens": "lens",
  "liverpool": "liverpool",
  "los angeles clippers": "los angeles clippers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles lakers": "los angeles lakers",
  "manchester city": "manchester city",
  "memphis grizzlies": "memphis grizzlies",
  "miami (ohio)": "miami (ohio)",
  "miami heat": "miami heat",
  "millwall": "millwall",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota timberwolves": "minnesota timberwolves",
  "mirassol": "mirassol",
  "monterrey": "monterrey",
  "nantes": "nantes",
  "new orleans pelicans": "new orleans pelicans",
  "new york knicks": "new york knicks",
  "newcastle united": "newcastle united",
  "north texas": "north texas",
  "norwich city": "norwich city",
  "nottingham": "nottingham",
  "ohio state": "ohio state",
  "oklahoma city thunder": "oklahoma city thunder",
  "orlando magic": "orlando magic",
  "philadelphia 76ers": "philadelphia 76ers",
  "phoenix suns": "phoenix suns",
  "portland trail blazers": "portland trail blazers",
  "prairie view a&m": "prairie view a&m",
  "psg": "psg",
  "rangers": "rangers",
  "rb leipzig": "rb leipzig",
  "real betis": "real betis",
  "real sociedad": "real sociedad",
  "rennes": "rennes",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "strasbourg": "strasbourg",
  "stuttgart": "stuttgart",
  "sunderland": "sunderland",
  "texas tech": "texas tech",
  "tigres uanl": "tigres uanl",
  "toluca": "toluca",
  "toronto blue jays": "toronto blue jays",
  "toronto raptors": "toronto raptors",
  "tottenham": "tottenham",
  "toulouse": "toulouse",
  "troy": "troy",
  "tulane": "tulane",
  "ufc 323: dvalishvili": "ufc 323: dvalishvili",
  "unlv": "unlv",
  "utah jazz": "utah jazz",
  "vanocuver whitecaps": "vanocuver whitecaps",
  "villarreal": "villarreal",
  "virginia": "virginia",
  "washington wizards": "washington wizards",
  "watford": "watford",
  "western michigan": "western michigan",
  "wwe smackdown": "wwe smackdown",
  "yan 2": "yan 2",
  "hawks": "atlanta hawks",
  "celtics": "boston celtics",
  "hornets": "charlotte hornets",
  "bulls": "chicago bulls",
  "cavaliers": "cleveland cavaliers",
  "mavericks": "dallas mavericks",
  "nuggets": "denver nuggets",
  "pistons": "detroit pistons",
  "warriors": "golden state warriors",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "lakers": "los angeles lakers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "magic": "orlando magic",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors",
  "jazz": "utah jazz",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "arsenal vs aston villa", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "derby county vs leicester city", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "norwich city vs watford", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "getafe vs villarreal", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "bayern münchen vs stuttgart", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "bournemouth vs chelsea", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "everton vs nottingham", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "manchester city vs sunderland", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "burnley vs newcastle united", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "brentford vs tottenham", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "bristol city vs millwall", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "coventry city vs ipswich town", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "deportivo alavés vs real sociedad", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "lens vs nantes", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "como vs inter milan", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "leeds vs liverpool", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "barcelona vs real betis", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "eintracht frankfurt vs rb leipzig", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "strasbourg vs toulouse", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "inter miami vs vanocuver whitecaps", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "atalanta vs hellas verona", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "athletic club vs atlético madrid", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "kilmarnock vs rangers", url: "https://roxiestreams.live/soccer-streams-12"},
  {title: "psg vs rennes", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "flamengo vs mirassol", url: "https://roxiestreams.live/soccer-streams-13"},
  {title: "monterrey vs toluca", url: "https://roxiestreams.live/soccer-streams-14"},
  {title: "cruz azul vs tigres uanl", url: "https://roxiestreams.live/soccer-streams-15"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "boston celtics vs los angeles lakers", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "miami heat vs orlando magic", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "atlanta hawks vs denver nuggets", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "cleveland cavaliers vs san antonio spurs", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "detroit pistons vs portland trail blazers", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "new york knicks vs utah jazz", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "charlotte hornets vs toronto raptors", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "chicago bulls vs indiana pacers", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "houston rockets vs phoenix suns", url: "https://roxiestreams.live/nba-streams-9"},
  {title: "los angeles clippers vs memphis grizzlies", url: "https://roxiestreams.live/nba-streams-10"},
  {title: "milwaukee bucks vs philadelphia 76ers", url: "https://roxiestreams.live/nba-streams-11"},
  {title: "dallas mavericks vs oklahoma city thunder", url: "https://roxiestreams.live/nba-streams-12"},
  {title: "brooklyn nets vs new orleans pelicans", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "atlanta hawks vs washington wizards", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "cleveland cavaliers vs golden state warriors", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "detroit pistons vs milwaukee bucks", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "miami heat vs sacramento kings", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "los angeles clippers vs minnesota timberwolves", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "dallas mavericks vs houston rockets", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "formula 1 - free practice", url: "https://roxiestreams.live/f1-streams"},
  {title: "formula 1 - free practice 2", url: "https://roxiestreams.live/f1-streams"},
  {title: "formula 1 - free practice 3", url: "https://roxiestreams.live/f1-streams"},
  {title: "formula 1 - qualifying", url: "https://roxiestreams.live/f1-streams"},
  {title: "formula e - sao paulo race", url: "https://roxiestreams.live/wec"},
  {title: "fim supercross championship", url: "https://roxiestreams.live/supercross"},
  {title: "formula 1 - abu dhabi grand prix", url: "https://roxiestreams.live/f1-streams"},
  {title: "wwe smackdown", url: "https://roxiestreams.live/wwe-streams"},
  {title: "ufc 323: dvalishvili vs yan 2", url: "https://roxiestreams.live/ufc"},
  {title: "jacksonville state vs kennesaw state", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "james madison vs troy", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "north texas vs tulane", url: "https://roxiestreams.live/ncaa-streams-3"},
  {title: "boise state vs unlv", url: "https://roxiestreams.live/ncaa-streams-4"},
  {title: "byu vs texas tech", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "miami (ohio) vs western michigan", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "jackson state vs prairie view a&m", url: "https://roxiestreams.live/ncaa-streams-3"},
  {title: "alabama vs georgia", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "indiana vs ohio state", url: "https://roxiestreams.live/ncaa-streams-5"},
  {title: "duke vs virginia", url: "https://roxiestreams.live/ncaa-streams-1"}
];

  const nbaTeams = new Set(["miami heat","washington wizards","cleveland cavaliers","los angeles clippers","memphis grizzlies","philadelphia 76ers","oklahoma city thunder","golden state warriors","denver nuggets","minnesota timberwolves","new orleans pelicans","toronto raptors","atlanta hawks","new york knicks","dallas mavericks","utah jazz","orlando magic","detroit pistons","boston celtics","sacramento kings","charlotte hornets","portland trail blazers","san antonio spurs","chicago bulls","phoenix suns","indiana pacers","milwaukee bucks","houston rockets","los angeles lakers"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.cc/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.cc/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.cc/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.cc/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.cc/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.cc/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
