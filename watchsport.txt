(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "aew": "aew",
  "al hilal": "al hilal",
  "al nassr": "al nassr",
  "ama supercross - race": "ama supercross - race",
  "atlanta hawks": "atlanta hawks",
  "barnsley": "barnsley",
  "boston bruins": "boston bruins",
  "boston celtics": "boston celtics",
  "brooklyn nets": "brooklyn nets",
  "buffalo bills": "buffalo bills",
  "buffalo sabres": "buffalo sabres",
  "cagliari": "cagliari",
  "carolina hurricanes": "carolina hurricanes",
  "celta vigo": "celta vigo",
  "charlotte hornets": "charlotte hornets",
  "chicago blackhawks": "chicago blackhawks",
  "cleveland cavaliers": "cleveland cavaliers",
  "colorado avalanche": "colorado avalanche",
  "columbus blue jackets": "columbus blue jackets",
  "cremonese": "cremonese",
  "dallas mavericks": "dallas mavericks",
  "dallas stars": "dallas stars",
  "denver nuggets": "denver nuggets",
  "detroit red wings": "detroit red wings",
  "edmonton oilers": "edmonton oilers",
  "florida panthers": "florida panthers",
  "formula e - grand prix": "formula e - grand prix",
  "genoa": "genoa",
  "golden state warriors": "golden state warriors",
  "houston rockets": "houston rockets",
  "houston texans": "houston texans",
  "indiana pacers": "indiana pacers",
  "jacksonville jaguars": "jacksonville jaguars",
  "juventus": "juventus",
  "liverpool": "liverpool",
  "los angeles chargers": "los angeles chargers",
  "los angeles clippers": "los angeles clippers",
  "los angeles kings": "los angeles kings",
  "los angeles lakers": "los angeles lakers",
  "memphis grizzlies": "memphis grizzlies",
  "miami heat": "miami heat",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota timberwolves": "minnesota timberwolves",
  "minnesota wild": "minnesota wild",
  "montreal canadiens": "montreal canadiens",
  "nashville predators": "nashville predators",
  "new england patriots": "new england patriots",
  "new jersey devils": "new jersey devils",
  "new orleans pelicans": "new orleans pelicans",
  "new york knicks": "new york knicks",
  "new york rangers": "new york rangers",
  "oklahoma city thunder": "oklahoma city thunder",
  "orlando magic": "orlando magic",
  "paris": "paris",
  "philadelphia 76ers": "philadelphia 76ers",
  "philadelphia eagles": "philadelphia eagles",
  "philadelphia flyers": "philadelphia flyers",
  "phoenix suns": "phoenix suns",
  "pittsburgh penguins": "pittsburgh penguins",
  "pittsburgh steelers": "pittsburgh steelers",
  "portland trail blazers": "portland trail blazers",
  "psg": "psg",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "san francisco 49ers": "san francisco 49ers",
  "san jose sharks": "san jose sharks",
  "seattle kraken": "seattle kraken",
  "sevilla": "sevilla",
  "tampa bay lightning": "tampa bay lightning",
  "toronto maple leafs": "toronto maple leafs",
  "toronto raptors": "toronto raptors",
  "utah jazz": "utah jazz",
  "utah mammoth": "utah mammoth",
  "vancouver canucks": "vancouver canucks",
  "vegas golden knights": "vegas golden knights",
  "washington capitals": "washington capitals",
  "washington wizards": "washington wizards",
  "winnipeg jets": "winnipeg jets",
  "wwe nxt": "wwe nxt",
  "wwe raw": "wwe raw",
  "hawks": "atlanta hawks",
  "celtics": "boston celtics",
  "hornets": "charlotte hornets",
  "cavaliers": "cleveland cavaliers",
  "mavericks": "dallas mavericks",
  "nuggets": "denver nuggets",
  "warriors": "golden state warriors",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "lakers": "los angeles lakers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "magic": "orlando magic",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors",
  "jazz": "utah jazz",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "al hilal vs al nassr", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "cagliari vs genoa", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "barnsley vs liverpool", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "cremonese vs juventus", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "celta vigo vs sevilla", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "paris vs psg", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "new orleans pelicans vs orlando magic", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "brooklyn nets vs memphis grizzlies", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "philadelphia 76ers vs toronto raptors", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "new york knicks vs portland trail blazers", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "minnesota timberwolves vs san antonio spurs", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "miami heat vs oklahoma city thunder", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "denver nuggets vs milwaukee bucks", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "phoenix suns vs washington wizards", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "atlanta hawks vs golden state warriors", url: "https://roxiestreams.live/nba-streams-9"},
  {title: "houston rockets vs sacramento kings", url: "https://roxiestreams.live/nba-streams-10"},
  {title: "cleveland cavaliers vs utah jazz", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "boston celtics vs indiana pacers", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "brooklyn nets vs dallas mavericks", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "los angeles lakers vs sacramento kings", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "charlotte hornets vs los angeles clippers", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "new jersey devils vs winnipeg jets", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "boston bruins vs pittsburgh penguins", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "nashville predators vs washington capitals", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "columbus blue jackets vs utah mammoth", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "san jose sharks vs vegas golden knights", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "buffalo sabres vs florida panthers", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "carolina hurricanes vs detroit red wings", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "new york rangers vs seattle kraken", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "philadelphia flyers vs tampa bay lightning", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "montreal canadiens vs vancouver canucks", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "minnesota wild vs new jersey devils", url: "https://roxiestreams.live/nhl-streams-6"},
  {title: "chicago blackhawks vs edmonton oilers", url: "https://roxiestreams.live/nhl-streams-7"},
  {title: "colorado avalanche vs toronto maple leafs", url: "https://roxiestreams.live/nhl-streams-8"},
  {title: "dallas stars vs los angeles kings", url: "https://roxiestreams.live/nhl-streams-9"},
  {title: "ama supercross - race", url: "https://roxiestreams.live/supercross"},
  {title: "formula e - grand prix", url: "https://roxiestreams.live/f1-streams"},
  {title: "wwe raw", url: "https://roxiestreams.live/wwe-streams"},
  {title: "wwe nxt", url: "https://roxiestreams.live/wwe-streams"},
  {title: "aew", url: "https://roxiestreams.live/aew"},
  {title: "buffalo bills vs jacksonville jaguars", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "philadelphia eagles vs san francisco 49ers", url: "https://roxiestreams.live/nfl-streams-2"},
  {title: "los angeles chargers vs new england patriots", url: "https://roxiestreams.live/nfl-streams-3"},
  {title: "houston texans vs pittsburgh steelers", url: "https://roxiestreams.live/nfl-streams-1"}
];

  const nbaTeams = new Set(["denver nuggets","golden state warriors","orlando magic","san antonio spurs","milwaukee bucks","utah jazz","miami heat","memphis grizzlies","minnesota timberwolves","sacramento kings","indiana pacers","cleveland cavaliers","washington wizards","boston celtics","detroit pistons","phoenix suns","oklahoma city thunder","new york knicks","houston rockets","charlotte hornets","philadelphia 76ers","portland trail blazers","new orleans pelicans","atlanta hawks","los angeles clippers","chicago bulls","toronto raptors","dallas mavericks","los angeles lakers"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.live/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.live/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.live/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.live/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.live/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.live/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
