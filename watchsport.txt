(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "angers": "angers",
  "arizona cardinals": "arizona cardinals",
  "atlanta falcons": "atlanta falcons",
  "bahia": "bahia",
  "baltimore ravens": "baltimore ravens",
  "boca juniors": "boca juniors",
  "bologna": "bologna",
  "boston celtics": "boston celtics",
  "brighton": "brighton",
  "buffalo bills": "buffalo bills",
  "buffalo sabres": "buffalo sabres",
  "cagliari": "cagliari",
  "calgary flames": "calgary flames",
  "ceará": "ceará",
  "celta vigo": "celta vigo",
  "celtic": "celtic",
  "charlotte hornets": "charlotte hornets",
  "chicago bears": "chicago bears",
  "chicago bulls": "chicago bulls",
  "cincinnati bengals": "cincinnati bengals",
  "cleveland browns": "cleveland browns",
  "cruz": "cruz",
  "crystal palace": "crystal palace",
  "denver broncos": "denver broncos",
  "denver nuggets": "denver nuggets",
  "detroit red wings": "detroit red wings",
  "dortmund": "dortmund",
  "elche": "elche",
  "espanyol": "espanyol",
  "fluminense": "fluminense",
  "formula 1 - abu dhabi grand prix": "formula 1 - abu dhabi grand prix",
  "fulham": "fulham",
  "girona": "girona",
  "golden state warriors": "golden state warriors",
  "green bay packers": "green bay packers",
  "hamburger sv": "hamburger sv",
  "hearts": "hearts",
  "hoffenheim": "hoffenheim",
  "houston texans": "houston texans",
  "indianapolis colts": "indianapolis colts",
  "jacksonville jaguars": "jacksonville jaguars",
  "juventus": "juventus",
  "kansas city chiefs": "kansas city chiefs",
  "las vegas raiders": "las vegas raiders",
  "lazio": "lazio",
  "le havre": "le havre",
  "lorient": "lorient",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles kings": "los angeles kings",
  "los angeles lakers": "los angeles lakers",
  "los angeles rams": "los angeles rams",
  "lyon": "lyon",
  "memphis grizzlies": "memphis grizzlies",
  "miami dolphins": "miami dolphins",
  "minnesota vikings": "minnesota vikings",
  "minnesota wild": "minnesota wild",
  "napoli": "napoli",
  "new orleans saints": "new orleans saints",
  "new york jets": "new york jets",
  "new york knicks": "new york knicks",
  "nfl redzone": "nfl redzone",
  "nice": "nice",
  "oklahoma city thunder": "oklahoma city thunder",
  "orlando magic": "orlando magic",
  "palmeiras": "palmeiras",
  "paris": "paris",
  "philadelphia 76ers": "philadelphia 76ers",
  "philadelphia eagles": "philadelphia eagles",
  "pittsburgh steelers": "pittsburgh steelers",
  "portland trail blazers": "portland trail blazers",
  "racing club": "racing club",
  "rayo vallecano": "rayo vallecano",
  "real madrid": "real madrid",
  "roach": "roach",
  "roma": "roma",
  "seattle kraken": "seattle kraken",
  "seattle seahawks": "seattle seahawks",
  "sevilla": "sevilla",
  "são paulo": "são paulo",
  "tampa bay buccaneers": "tampa bay buccaneers",
  "tampa bay lightning": "tampa bay lightning",
  "tennessee titans": "tennessee titans",
  "toronto blue jays": "toronto blue jays",
  "toronto maple leafs": "toronto maple leafs",
  "toronto raptors": "toronto raptors",
  "ufc 323: dvalishvili": "ufc 323: dvalishvili",
  "utah jazz": "utah jazz",
  "utah mammoth": "utah mammoth",
  "valencia": "valencia",
  "vancouver canucks": "vancouver canucks",
  "vitória": "vitória",
  "washington commanders": "washington commanders",
  "werder bremen": "werder bremen",
  "west ham": "west ham",
  "wwe nxt deadline": "wwe nxt deadline",
  "yan 2": "yan 2",
  "celtics": "boston celtics",
  "hornets": "charlotte hornets",
  "bulls": "chicago bulls",
  "nuggets": "denver nuggets",
  "warriors": "golden state warriors",
  "lakers": "los angeles lakers",
  "grizzlies": "memphis grizzlies",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "magic": "orlando magic",
  "sixers": "philadelphia 76ers",
  "blazers": "portland trail blazers",
  "raptors": "toronto raptors",
  "jazz": "utah jazz"
};

  const roxieStreamsCached = [
  {title: "elche vs girona", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "brighton vs west ham", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "angers vs nice", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "cagliari vs roma", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "hamburger sv vs werder bremen", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "celtic vs hearts", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "sevilla vs valencia", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "le havre vs paris", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "dortmund vs hoffenheim", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "crystal palace vs fulham", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "bologna vs lazio", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "espanyol vs rayo vallecano", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "ceará vs palmeiras", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "bahia vs fluminense", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "são paulo vs vitória", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "juventus vs napoli", url: "https://roxiestreams.live/soccer-streams-13"},
  {title: "lorient vs lyon", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "celta vigo vs real madrid", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "boca juniors vs racing club", url: "https://roxiestreams.live/soccer-streams-14"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "new york knicks vs orlando magic", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "boston celtics vs toronto raptors", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "charlotte hornets vs denver nuggets", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "memphis grizzlies vs portland trail blazers", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "chicago bulls vs golden state warriors", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "los angeles lakers vs philadelphia 76ers", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "oklahoma city thunder vs utah jazz", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "formula 1 - abu dhabi grand prix", url: "https://roxiestreams.live/f1-streams"},
  {title: "cruz vs roach", url: "https://roxiestreams.live/ppv-streams-1"},
  {title: "wwe nxt deadline", url: "https://roxiestreams.live/wwe-streams"},
  {title: "ufc 323: dvalishvili vs yan 2", url: "https://roxiestreams.live/ufc"},
  {title: "nfl redzone", url: "https://roxiestreams.live/redzone"},
  {title: "atlanta falcons vs seattle seahawks", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "buffalo bills vs cincinnati bengals", url: "https://roxiestreams.live/nfl-streams-2"},
  {title: "cleveland browns vs tennessee titans", url: "https://roxiestreams.live/nfl-streams-3"},
  {title: "minnesota vikings vs washington commanders", url: "https://roxiestreams.live/nfl-streams-4"},
  {title: "miami dolphins vs new york jets", url: "https://roxiestreams.live/nfl-streams-5"},
  {title: "new orleans saints vs tampa bay buccaneers", url: "https://roxiestreams.live/nfl-streams-6"},
  {title: "indianapolis colts vs jacksonville jaguars", url: "https://roxiestreams.live/nfl-streams-7"},
  {title: "baltimore ravens vs pittsburgh steelers", url: "https://roxiestreams.live/nfl-streams-8"},
  {title: "denver broncos vs las vegas raiders", url: "https://roxiestreams.live/nfl-streams-9"},
  {title: "chicago bears vs green bay packers", url: "https://roxiestreams.live/nfl-streams-10"},
  {title: "arizona cardinals vs los angeles rams", url: "https://roxiestreams.live/nfl-streams-11"},
  {title: "houston texans vs kansas city chiefs", url: "https://roxiestreams.live/nfl-streams-12"},
  {title: "los angeles rams vs philadelphia eagles", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "tampa bay lightning vs toronto maple leafs", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "los angeles kings vs utah mammoth", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "buffalo sabres vs calgary flames", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "detroit red wings vs vancouver canucks", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "minnesota wild vs seattle kraken", url: "https://roxiestreams.live/nhl-streams-5"}
];

  const nbaTeams = new Set(["los angeles clippers","sacramento kings","new orleans pelicans","denver nuggets","cleveland cavaliers","washington wizards","new york knicks","miami heat","san antonio spurs","portland trail blazers","indiana pacers","charlotte hornets","orlando magic","chicago bulls","toronto raptors","boston celtics","memphis grizzlies","minnesota timberwolves","oklahoma city thunder","golden state warriors","milwaukee bucks","phoenix suns","dallas mavericks","houston rockets","detroit pistons","los angeles lakers","philadelphia 76ers","atlanta hawks","utah jazz"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.live/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.live/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.live/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.live/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.live/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.live/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
