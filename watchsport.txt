(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "ama supercross glendale - heats & race": "ama supercross glendale - heats & race",
  "ama supercross glendale - qualifying": "ama supercross glendale - qualifying",
  "america": "america",
  "américa mineiro": "américa mineiro",
  "athletic club": "athletic club",
  "atlanta hawks": "atlanta hawks",
  "atlético madrid": "atlético madrid",
  "auxerre": "auxerre",
  "ball": "ball",
  "bayern münchen": "bayern münchen",
  "bkfc: knuckle mania 6": "bkfc: knuckle mania 6",
  "boca juniors": "boca juniors",
  "bologna": "bologna",
  "boston celtics": "boston celtics",
  "brighton": "brighton",
  "brooklyn nets": "brooklyn nets",
  "charlotte hornets": "charlotte hornets",
  "chicago bulls": "chicago bulls",
  "cleveland cavaliers": "cleveland cavaliers",
  "cruzeiro": "cruzeiro",
  "crystal palace": "crystal palace",
  "dallas mavericks": "dallas mavericks",
  "davis": "davis",
  "denver nuggets": "denver nuggets",
  "deportivo alavés": "deportivo alavés",
  "figueroa": "figueroa",
  "fluminense": "fluminense",
  "getafe": "getafe",
  "golden state warriors": "golden state warriors",
  "hoffenheim": "hoffenheim",
  "houston rockets": "houston rockets",
  "indiana pacers": "indiana pacers",
  "inter milan": "inter milan",
  "juventus": "juventus",
  "köln": "köln",
  "lazio": "lazio",
  "lecce": "lecce",
  "leipzig": "leipzig",
  "levante": "levante",
  "liverpool": "liverpool",
  "los angeles clippers": "los angeles clippers",
  "los angeles lakers": "los angeles lakers",
  "man city": "man city",
  "maricá": "maricá",
  "marseille": "marseille",
  "memphis grizzlies": "memphis grizzlies",
  "miami heat": "miami heat",
  "minnesota timberwolves": "minnesota timberwolves",
  "monaco": "monaco",
  "monterrey": "monterrey",
  "new england patriots": "new england patriots",
  "new york knicks": "new york knicks",
  "nice": "nice",
  "oklahoma city thunder": "oklahoma city thunder",
  "oliveira": "oliveira",
  "orlando magic": "orlando magic",
  "paris": "paris",
  "parma": "parma",
  "pfl road to dubai: nurmagomedov": "pfl road to dubai: nurmagomedov",
  "philadelphia 76ers": "philadelphia 76ers",
  "phoenix suns": "phoenix suns",
  "portland trail blazers": "portland trail blazers",
  "psg": "psg",
  "queen's park": "queen's park",
  "rangers": "rangers",
  "real betis": "real betis",
  "real madrid": "real madrid",
  "redneck brawl 12": "redneck brawl 12",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "sassuolo": "sassuolo",
  "seattle seahawks": "seattle seahawks",
  "toronto raptors": "toronto raptors",
  "udinese": "udinese",
  "ufc fight night: bautista": "ufc fight night: bautista",
  "utah jazz": "utah jazz",
  "valencia": "valencia",
  "vélez sarsfield": "vélez sarsfield",
  "washington wizards": "washington wizards",
  "hawks": "atlanta hawks",
  "celtics": "boston celtics",
  "hornets": "charlotte hornets",
  "bulls": "chicago bulls",
  "cavaliers": "cleveland cavaliers",
  "mavericks": "dallas mavericks",
  "nuggets": "denver nuggets",
  "warriors": "golden state warriors",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "lakers": "los angeles lakers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "timberwolves": "minnesota timberwolves",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "magic": "orlando magic",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs",
  "raptors": "toronto raptors",
  "jazz": "utah jazz",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "america vs monterrey", url: "https://roxiestreams.info/soccer-streams-16"},
  {title: "bologna vs parma", url: "https://roxiestreams.info/soccer-streams-1"},
  {title: "deportivo alavés vs getafe", url: "https://roxiestreams.info/soccer-streams-2"},
  {title: "brighton vs crystal palace", url: "https://roxiestreams.info/soccer-streams-3"},
  {title: "lecce vs udinese", url: "https://roxiestreams.info/soccer-streams-1"},
  {title: "monaco vs nice", url: "https://roxiestreams.info/soccer-streams-4"},
  {title: "queen's park vs rangers", url: "https://roxiestreams.info/soccer-streams-5"},
  {title: "köln vs leipzig", url: "https://roxiestreams.info/soccer-streams-6"},
  {title: "athletic club vs levante", url: "https://roxiestreams.info/soccer-streams-2"},
  {title: "auxerre vs paris", url: "https://roxiestreams.info/soccer-streams-4"},
  {title: "liverpool vs man city", url: "https://roxiestreams.info/soccer-streams-7"},
  {title: "bayern münchen vs hoffenheim", url: "https://roxiestreams.info/soccer-streams-6"},
  {title: "inter milan vs sassuolo", url: "https://roxiestreams.info/soccer-streams-1"},
  {title: "atlético madrid vs real betis", url: "https://roxiestreams.info/soccer-streams-2"},
  {title: "marseille vs psg", url: "https://roxiestreams.info/soccer-streams-4"},
  {title: "juventus vs lazio", url: "https://roxiestreams.info/soccer-streams-1"},
  {title: "real madrid vs valencia", url: "https://roxiestreams.info/soccer-streams-2"},
  {title: "américa mineiro vs cruzeiro", url: "https://roxiestreams.info/soccer-streams-8"},
  {title: "fluminense vs maricá", url: "https://roxiestreams.info/soccer-streams-8"},
  {title: "boca juniors vs vélez sarsfield", url: "https://roxiestreams.info/soccer-streams-9"},
  {title: "brooklyn nets vs washington wizards", url: "https://roxiestreams.info/nba-streams-1"},
  {title: "houston rockets vs oklahoma city thunder", url: "https://roxiestreams.info/nba-streams-2"},
  {title: "dallas mavericks vs san antonio spurs", url: "https://roxiestreams.info/nba-streams-3"},
  {title: "orlando magic vs utah jazz", url: "https://roxiestreams.info/nba-streams-4"},
  {title: "atlanta hawks vs charlotte hornets", url: "https://roxiestreams.info/nba-streams-5"},
  {title: "chicago bulls vs denver nuggets", url: "https://roxiestreams.info/nba-streams-6"},
  {title: "golden state warriors vs los angeles lakers", url: "https://roxiestreams.info/nba-streams-7"},
  {title: "philadelphia 76ers vs phoenix suns", url: "https://roxiestreams.info/nba-streams-8"},
  {title: "memphis grizzlies vs portland trail blazers", url: "https://roxiestreams.info/nba-streams-9"},
  {title: "cleveland cavaliers vs sacramento kings", url: "https://roxiestreams.info/nba-streams-10"},
  {title: "boston celtics vs new york knicks", url: "https://roxiestreams.info/nba-streams-1"},
  {title: "miami heat vs washington wizards", url: "https://roxiestreams.info/nba-streams-2"},
  {title: "indiana pacers vs toronto raptors", url: "https://roxiestreams.info/nba-streams-3"},
  {title: "los angeles clippers vs minnesota timberwolves", url: "https://roxiestreams.info/nba-streams-4"},
  {title: "ama supercross glendale - qualifying", url: "https://roxiestreams.info/supercross"},
  {title: "ama supercross glendale - heats & race", url: "https://roxiestreams.info/supercross"},
  {title: "davis vs pfl road to dubai: nurmagomedov", url: "https://roxiestreams.info/ppv-streams-1"},
  {title: "ball vs figueroa", url: "https://roxiestreams.info/ppv-streams-2"},
  {title: "oliveira vs ufc fight night: bautista", url: "https://roxiestreams.info/ufc"},
  {title: "redneck brawl 12", url: "https://roxiestreams.info/ppv-streams-3"},
  {title: "bkfc: knuckle mania 6", url: "https://roxiestreams.info/ppv-streams-4"},
  {title: "new england patriots vs seattle seahawks", url: "https://roxiestreams.info/nfl-streams-1"}
];

  const nbaTeams = new Set(["new york knicks","miami heat","denver nuggets","dallas mavericks","los angeles lakers","minnesota timberwolves","orlando magic","indiana pacers","sacramento kings","portland trail blazers","cleveland cavaliers","utah jazz","memphis grizzlies","chicago bulls","toronto raptors","washington wizards","detroit pistons","san antonio spurs","atlanta hawks","boston celtics","los angeles clippers","charlotte hornets","phoenix suns","oklahoma city thunder","golden state warriors","houston rockets","milwaukee bucks","philadelphia 76ers","new orleans pelicans"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.info/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.info/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.info/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.info/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.info/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.info/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
