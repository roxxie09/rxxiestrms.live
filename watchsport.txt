(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "angers sco": "angers sco",
  "arizona cardinals": "arizona cardinals",
  "atlanta falcons": "atlanta falcons",
  "austin": "austin",
  "bahia": "bahia",
  "barcelona": "barcelona",
  "boca juniors": "boca juniors",
  "boston celtics": "boston celtics",
  "bournemouth": "bournemouth",
  "bragantino": "bragantino",
  "brest": "brest",
  "brooklyn nets": "brooklyn nets",
  "buffallo bills": "buffallo bills",
  "carolina panthers": "carolina panthers",
  "ceará": "ceará",
  "celtic": "celtic",
  "chicago bears": "chicago bears",
  "chivas": "chivas",
  "cincinnati bengals": "cincinnati bengals",
  "corinthians": "corinthians",
  "dallas cowboys": "dallas cowboys",
  "dallas mavericks": "dallas mavericks",
  "denver broncos": "denver broncos",
  "denver nuggets": "denver nuggets",
  "deportivo alavés": "deportivo alavés",
  "detroit lions": "detroit lions",
  "detroit pistons": "detroit pistons",
  "east": "east",
  "elche": "elche",
  "espanyol": "espanyol",
  "estudiantes": "estudiantes",
  "everton": "everton",
  "fluminense": "fluminense",
  "gimnasia la plata": "gimnasia la plata",
  "green bay packers": "green bay packers",
  "grêmio": "grêmio",
  "houston rockets": "houston rockets",
  "houston texans": "houston texans",
  "indiana pacers": "indiana pacers",
  "indianapolis colts": "indianapolis colts",
  "jacksonville jaguars": "jacksonville jaguars",
  "juventude": "juventude",
  "kansas chiefs": "kansas chiefs",
  "lafc": "lafc",
  "las vegas raiders": "las vegas raiders",
  "lens": "lens",
  "lille": "lille",
  "lorient": "lorient",
  "los angeles chargers": "los angeles chargers",
  "los angeles clippers": "los angeles clippers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles lakers": "los angeles lakers",
  "los angeles rams": "los angeles rams",
  "lyon": "lyon",
  "manchester city": "manchester city",
  "mazatlán": "mazatlán",
  "memphis grizzlies": "memphis grizzlies",
  "miami heat": "miami heat",
  "milan": "milan",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota": "minnesota",
  "minnesota timberwolves": "minnesota timberwolves",
  "minnesota vikings": "minnesota vikings",
  "nascar cup series - race": "nascar cup series - race",
  "new england patriots": "new england patriots",
  "new orleans saints": "new orleans saints",
  "new york knicks": "new york knicks",
  "nfl redzone": "nfl redzone",
  "onama": "onama",
  "osauna": "osauna",
  "pachuca": "pachuca",
  "palmeiras": "palmeiras",
  "pittsburgh steelers": "pittsburgh steelers",
  "portland trail blazers": "portland trail blazers",
  "pumas unam": "pumas unam",
  "querétaro": "querétaro",
  "rangers": "rangers",
  "real oviedo": "real oviedo",
  "rennes": "rennes",
  "river plate": "river plate",
  "roma": "roma",
  "sacramento kings": "sacramento kings",
  "seattle seahawks": "seattle seahawks",
  "seattle sounders": "seattle sounders",
  "strasbourg": "strasbourg",
  "sunderland": "sunderland",
  "são paulo": "são paulo",
  "tennessee titans": "tennessee titans",
  "tijuana": "tijuana",
  "toronto blue jays": "toronto blue jays",
  "ufc vegas 110: garcia": "ufc vegas 110: garcia",
  "utah jazz": "utah jazz",
  "vasco da gama": "vasco da gama",
  "washington commanders": "washington commanders",
  "washington wizards": "washington wizards",
  "west 20": "west 20",
  "wwe raw": "wwe raw",
  "wwe saturday night's main event": "wwe saturday night's main event",
  "celtics": "boston celtics",
  "mavericks": "dallas mavericks",
  "nuggets": "denver nuggets",
  "pistons": "detroit pistons",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "lakers": "los angeles lakers",
  "grizzlies": "memphis grizzlies",
  "heat": "miami heat",
  "bucks": "milwaukee bucks",
  "timberwolves": "minnesota timberwolves",
  "knicks": "new york knicks",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "jazz": "utah jazz",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "osauna vs real oviedo", url: "https://roxiestreams.cc/soccer-streams-1"},
  {title: "everton vs sunderland", url: "https://roxiestreams.cc/soccer-streams-2"},
  {title: "minnesota vs seattle sounders", url: "https://roxiestreams.cc/soccer-streams-3"},
  {title: "rennes vs strasbourg", url: "https://roxiestreams.cc/soccer-streams-4"},
  {title: "celtic vs rangers", url: "https://roxiestreams.cc/soccer-streams-1"},
  {title: "deportivo alavés vs espanyol", url: "https://roxiestreams.cc/soccer-streams-2"},
  {title: "lens vs lorient", url: "https://roxiestreams.cc/soccer-streams-5"},
  {title: "angers sco vs lille", url: "https://roxiestreams.cc/soccer-streams-4"},
  {title: "bournemouth vs manchester city", url: "https://roxiestreams.cc/soccer-streams-3"},
  {title: "barcelona vs elche", url: "https://roxiestreams.cc/soccer-streams-2"},
  {title: "pumas unam vs tijuana", url: "https://roxiestreams.cc/soccer-streams-6"},
  {title: "bahia vs bragantino", url: "https://roxiestreams.cc/soccer-streams-8"},
  {title: "corinthians vs grêmio", url: "https://roxiestreams.cc/soccer-streams-7"},
  {title: "boca juniors vs estudiantes", url: "https://roxiestreams.cc/soccer-streams-9"},
  {title: "ceará vs fluminense", url: "https://roxiestreams.cc/soccer-streams-14"},
  {title: "milan vs roma", url: "https://roxiestreams.cc/soccer-streams-10"},
  {title: "brest vs lyon", url: "https://roxiestreams.cc/soccer-streams-4"},
  {title: "juventude vs palmeiras", url: "https://roxiestreams.cc/soccer-streams-13"},
  {title: "mazatlán vs querétaro", url: "https://roxiestreams.cc/soccer-streams-11"},
  {title: "são paulo vs vasco da gama", url: "https://roxiestreams.cc/soccer-streams-7"},
  {title: "gimnasia la plata vs river plate", url: "https://roxiestreams.cc/soccer-streams-9"},
  {title: "chivas vs pachuca", url: "https://roxiestreams.cc/soccer-streams-12"},
  {title: "austin vs lafc", url: "https://roxiestreams.cc/soccer-streams-15"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.cc/mlb-streams-1"},
  {title: "indiana pacers vs milwaukee bucks", url: "https://roxiestreams.cc/nba-streams-1"},
  {title: "brooklyn nets vs minnesota timberwolves", url: "https://roxiestreams.cc/nba-streams-2"},
  {title: "new york knicks vs washington wizards", url: "https://roxiestreams.cc/nba-streams-3"},
  {title: "boston celtics vs utah jazz", url: "https://roxiestreams.cc/nba-streams-4"},
  {title: "detroit pistons vs memphis grizzlies", url: "https://roxiestreams.cc/nba-streams-5"},
  {title: "dallas mavericks vs houston rockets", url: "https://roxiestreams.cc/nba-streams-6"},
  {title: "denver nuggets vs sacramento kings", url: "https://roxiestreams.cc/nba-streams-7"},
  {title: "los angeles lakers vs portland trail blazers", url: "https://roxiestreams.cc/nba-streams-8"},
  {title: "los angeles clippers vs miami heat", url: "https://roxiestreams.cc/nba-streams-9"},
  {title: "nascar cup series - race", url: "https://roxiestreams.cc/nascar"},
  {title: "east vs west 20", url: "https://roxiestreams.cc/ppv-streams-1"},
  {title: "onama vs ufc vegas 110: garcia", url: "https://roxiestreams.cc/ufc"},
  {title: "wwe saturday night's main event", url: "https://roxiestreams.cc/wwe-streams"},
  {title: "wwe raw", url: "https://roxiestreams.cc/wwe-streams"},
  {title: "nfl redzone", url: "https://roxiestreams.cc/redzone"},
  {title: "arizona cardinals vs dallas cowboys", url: "https://roxiestreams.cc/nfl-streams-1"},
  {title: "los angeles chargers vs tennessee titans", url: "https://roxiestreams.cc/nfl-streams-2"},
  {title: "detroit lions vs minnesota vikings", url: "https://roxiestreams.cc/nfl-streams-3"},
  {title: "atlanta falcons vs new england patriots", url: "https://roxiestreams.cc/nfl-streams-4"},
  {title: "indianapolis colts vs pittsburgh steelers", url: "https://roxiestreams.cc/nfl-streams-5"},
  {title: "denver broncos vs houston texans", url: "https://roxiestreams.cc/nfl-streams-6"},
  {title: "chicago bears vs cincinnati bengals", url: "https://roxiestreams.cc/nfl-streams-7"},
  {title: "carolina panthers vs green bay packers", url: "https://roxiestreams.cc/nfl-streams-8"},
  {title: "los angeles rams vs new orleans saints", url: "https://roxiestreams.cc/nfl-streams-9"},
  {title: "jacksonville jaguars vs las vegas raiders", url: "https://roxiestreams.cc/nfl-streams-10"},
  {title: "buffallo bills vs kansas chiefs", url: "https://roxiestreams.cc/nfl-streams-11"},
  {title: "seattle seahawks vs washington commanders", url: "https://roxiestreams.cc/nfl-streams-12"}
];

  const nbaTeams = new Set(["miami heat","charlotte hornets","memphis grizzlies","los angeles lakers","oklahoma city thunder","milwaukee bucks","orlando magic","dallas mavericks","los angeles clippers","chicago bulls","golden state warriors","san antonio spurs","philadelphia 76ers","phoenix suns","indiana pacers","denver nuggets","portland trail blazers","detroit pistons","boston celtics","washington wizards","sacramento kings","houston rockets","cleveland cavaliers","new orleans pelicans","new york knicks","utah jazz","toronto raptors","minnesota timberwolves","atlanta hawks"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.cc/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.cc/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.cc/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.cc/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.cc/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 400)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.cc/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 400));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 400));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
