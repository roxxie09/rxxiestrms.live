(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "arizona cardinals": "arizona cardinals",
  "arsenal": "arsenal",
  "atlético madrid": "atlético madrid",
  "bayern münchen": "bayern münchen",
  "bodø / glimt": "bodø / glimt",
  "boston celtics": "boston celtics",
  "brooklyn nets": "brooklyn nets",
  "cleveland cavaliers": "cleveland cavaliers",
  "dallas cowboys": "dallas cowboys",
  "detroit pistons": "detroit pistons",
  "frankfurt": "frankfurt",
  "houston rockets": "houston rockets",
  "indiana pacers": "indiana pacers",
  "juventus": "juventus",
  "københavn": "københavn",
  "liverpool": "liverpool",
  "los angeles clippers": "los angeles clippers",
  "los angeles dodgers": "los angeles dodgers",
  "memphis grizzlies": "memphis grizzlies",
  "minnesota timberwolves": "minnesota timberwolves",
  "monaco": "monaco",
  "napoli": "napoli",
  "nascar cup series - race": "nascar cup series - race",
  "new york knicks": "new york knicks",
  "oklahoma city thunder": "oklahoma city thunder",
  "olympiakos piraeus": "olympiakos piraeus",
  "philadelphia 76ers": "philadelphia 76ers",
  "phoenix suns": "phoenix suns",
  "psg": "psg",
  "psv": "psv",
  "real madrid": "real madrid",
  "san antonio spurs": "san antonio spurs",
  "slavia prague": "slavia prague",
  "sporting cp": "sporting cp",
  "toronto blue jays": "toronto blue jays",
  "tottenham hotspur": "tottenham hotspur",
  "uefa goal show": "uefa goal show",
  "union saint-gilloise": "union saint-gilloise",
  "utah jazz": "utah jazz",
  "washington wizards": "washington wizards",
  "wwe nxt": "wwe nxt",
  "wwe smackdown": "wwe smackdown",
  "celtics": "boston celtics",
  "cavaliers": "cleveland cavaliers",
  "pistons": "detroit pistons",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "grizzlies": "memphis grizzlies",
  "timberwolves": "minnesota timberwolves",
  "knicks": "new york knicks",
  "thunder": "oklahoma city thunder",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "spurs": "san antonio spurs",
  "jazz": "utah jazz",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "arsenal vs slavia prague", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "frankfurt vs napoli", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "uefa goal show", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "bayern münchen vs psg", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "københavn vs tottenham hotspur", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "liverpool vs real madrid", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "olympiakos piraeus vs psv", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "atlético madrid vs union saint-gilloise", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "bodø / glimt vs monaco", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "juventus vs sporting cp", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "detroit pistons vs utah jazz", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "cleveland cavaliers vs philadelphia 76ers", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "brooklyn nets vs indiana pacers", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "boston celtics vs washington wizards", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "minnesota timberwolves vs new york knicks", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "houston rockets vs memphis grizzlies", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "phoenix suns vs san antonio spurs", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "los angeles clippers vs oklahoma city thunder", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "nascar cup series - race", url: "https://roxiestreams.live/nascar"},
  {title: "wwe nxt", url: "https://roxiestreams.live/wwe-streams"},
  {title: "wwe smackdown", url: "https://roxiestreams.live/wwe-streams"},
  {title: "arizona cardinals vs dallas cowboys", url: "https://roxiestreams.live/nfl-streams-1"}
];

  const nbaTeams = new Set(["orlando magic","washington wizards","dallas mavericks","los angeles lakers","new orleans pelicans","indiana pacers","new york knicks","los angeles clippers","detroit pistons","denver nuggets","utah jazz","atlanta hawks","oklahoma city thunder","houston rockets","phoenix suns","charlotte hornets","chicago bulls","cleveland cavaliers","philadelphia 76ers","minnesota timberwolves","miami heat","sacramento kings","golden state warriors","portland trail blazers","toronto raptors","memphis grizzlies","boston celtics","san antonio spurs","milwaukee bucks"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.cc/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.cc/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.cc/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.cc/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.cc/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 400)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.cc/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 400));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 400));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
