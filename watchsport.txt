(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "al nassr": "al nassr",
  "al shabab": "al shabab",
  "ama supercross - qualifying": "ama supercross - qualifying",
  "ama supercross - race": "ama supercross - race",
  "anaheim ducks": "anaheim ducks",
  "angers sco": "angers sco",
  "annan athletic": "annan athletic",
  "arsenal": "arsenal",
  "atalanta": "atalanta",
  "athletic club": "athletic club",
  "atlas": "atlas",
  "auxerre": "auxerre",
  "bayern münchen": "bayern münchen",
  "benfica": "benfica",
  "blackburn rovers": "blackburn rovers",
  "boavista": "boavista",
  "boston bruins": "boston bruins",
  "brentford": "brentford",
  "brooklyn nets": "brooklyn nets",
  "buffalo bills": "buffalo bills",
  "buffalo sabres": "buffalo sabres",
  "burnley": "burnley",
  "cagliari": "cagliari",
  "calgary flames": "calgary flames",
  "canada": "canada",
  "carolina hurricanes": "carolina hurricanes",
  "chelsea": "chelsea",
  "chicago blackhawks": "chicago blackhawks",
  "chicago bulls": "chicago bulls",
  "chivas": "chivas",
  "cleveland cavaliers": "cleveland cavaliers",
  "colorado avalanche": "colorado avalanche",
  "columbus blue jackets": "columbus blue jackets",
  "coventry city": "coventry city",
  "cruz azul": "cruz azul",
  "crystal palace": "crystal palace",
  "denver broncos": "denver broncos",
  "derby county": "derby county",
  "detroit red wings": "detroit red wings",
  "edmonton oilers": "edmonton oilers",
  "egypt": "egypt",
  "espanyol": "espanyol",
  "flamengo": "flamengo",
  "florida panthers": "florida panthers",
  "flumiense": "flumiense",
  "frankfurt": "frankfurt",
  "fulham": "fulham",
  "girona": "girona",
  "grêmio": "grêmio",
  "guatemala": "guatemala",
  "houston rockets": "houston rockets",
  "indiana pacers": "indiana pacers",
  "inter milan": "inter milan",
  "ipswich town": "ipswich town",
  "juventus": "juventus",
  "leeds united": "leeds united",
  "leicester city": "leicester city",
  "lens": "lens",
  "levante": "levante",
  "lille": "lille",
  "liverpool": "liverpool",
  "lorient": "lorient",
  "los angeles clippers": "los angeles clippers",
  "los angeles kings": "los angeles kings",
  "mallorca": "mallorca",
  "manchester city": "manchester city",
  "manchester united": "manchester united",
  "marseille": "marseille",
  "mazatlán": "mazatlán",
  "middlesbrough": "middlesbrough",
  "millwall": "millwall",
  "minnesota timberwolves": "minnesota timberwolves",
  "minnesota wild": "minnesota wild",
  "monaco": "monaco",
  "monterrey": "monterrey",
  "montreal canadiens": "montreal canadiens",
  "napoli": "napoli",
  "nashville predators": "nashville predators",
  "necaxa": "necaxa",
  "new jersey devils": "new jersey devils",
  "new orleans pelicans": "new orleans pelicans",
  "new york islanders": "new york islanders",
  "new york rangers": "new york rangers",
  "nice": "nice",
  "nigeria": "nigeria",
  "nottingham forest": "nottingham forest",
  "osasuna": "osasuna",
  "ottawa senators": "ottawa senators",
  "peñarol": "peñarol",
  "philadelphia 76ers": "philadelphia 76ers",
  "philadelphia flyers": "philadelphia flyers",
  "pisa": "pisa",
  "pittsburgh penguins": "pittsburgh penguins",
  "preston north end": "preston north end",
  "psg": "psg",
  "puebla": "puebla",
  "queens park rangers": "queens park rangers",
  "querétaro": "querétaro",
  "rangers": "rangers",
  "rb leipzig": "rb leipzig",
  "real betis": "real betis",
  "real madrid": "real madrid",
  "real oviedo": "real oviedo",
  "rio ave": "rio ave",
  "river plate": "river plate",
  "sacramento kings": "sacramento kings",
  "san francisco 49ers": "san francisco 49ers",
  "san jose sharks": "san jose sharks",
  "sassuolo": "sassuolo",
  "seattle kraken": "seattle kraken",
  "seattle seahawks": "seattle seahawks",
  "st. louis blues": "st. louis blues",
  "stoke city": "stoke city",
  "sunderland": "sunderland",
  "são luiz": "são luiz",
  "tampa bay lightning": "tampa bay lightning",
  "tigres uanl": "tigres uanl",
  "toluca": "toluca",
  "toronto maple leafs": "toronto maple leafs",
  "toronto raptors": "toronto raptors",
  "tottenham": "tottenham",
  "toulouse": "toulouse",
  "udinese": "udinese",
  "utah mammoth": "utah mammoth",
  "vancouver canucks": "vancouver canucks",
  "vegas golden knights": "vegas golden knights",
  "villarreal": "villarreal",
  "volta redonda": "volta redonda",
  "washington capitals": "washington capitals",
  "washington wizards": "washington wizards",
  "watford": "watford",
  "werder bremen": "werder bremen",
  "west bromwich albion": "west bromwich albion",
  "west ham": "west ham",
  "winnipeg jets": "winnipeg jets",
  "wwe smackdown": "wwe smackdown",
  "bulls": "chicago bulls",
  "cavaliers": "cleveland cavaliers",
  "rockets": "houston rockets",
  "pacers": "indiana pacers",
  "clippers": "los angeles clippers",
  "timberwolves": "minnesota timberwolves",
  "pelicans": "new orleans pelicans",
  "sixers": "philadelphia 76ers",
  "kings": "sacramento kings",
  "raptors": "toronto raptors",
  "wizards": "washington wizards"
};

  const roxieStreamsCached = [
  {title: "lorient vs monaco", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "frankfurt vs werder bremen", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "atalanta vs pisa", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "annan athletic vs rangers", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "lille vs psg", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "espanyol vs girona", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "middlesbrough vs west bromwich albion", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "mazatlán vs monterrey", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "manchester city vs manchester united", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "blackburn rovers vs ipswich town", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "millwall vs watford", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "coventry city vs leicester city", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "levante vs real madrid", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "inter milan vs udinese", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "brentford vs chelsea", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "fulham vs leeds united", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "crystal palace vs sunderland", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "tottenham vs west ham", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "burnley vs liverpool", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "derby county vs preston north end", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "queens park rangers vs stoke city", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "athletic club vs mallorca", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "egypt vs nigeria", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "auxerre vs lens", url: "https://roxiestreams.live/soccer-streams-12"},
  {title: "napoli vs sassuolo", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "al nassr vs al shabab", url: "https://roxiestreams.live/soccer-streams-13"},
  {title: "arsenal vs nottingham forest", url: "https://roxiestreams.live/soccer-streams-14"},
  {title: "bayern münchen vs rb leipzig", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "osasuna vs real oviedo", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "nice vs toulouse", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "cagliari vs juventus", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "real betis vs villarreal", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "angers sco vs marseille", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "benfica vs rio ave", url: "https://roxiestreams.live/soccer-streams-12"},
  {title: "boavista vs flumiense", url: "https://roxiestreams.live/soccer-streams-13"},
  {title: "grêmio vs são luiz", url: "https://roxiestreams.live/soccer-streams-14"},
  {title: "atlas vs necaxa", url: "https://roxiestreams.live/soccer-streams-15"},
  {title: "chivas vs querétaro", url: "https://roxiestreams.live/soccer-streams-16"},
  {title: "flamengo vs volta redonda", url: "https://roxiestreams.live/soccer-streams-14"},
  {title: "peñarol vs river plate", url: "https://roxiestreams.live/soccer-streams-17"},
  {title: "tigres uanl vs toluca", url: "https://roxiestreams.live/soccer-streams-16"},
  {title: "cruz azul vs puebla", url: "https://roxiestreams.live/soccer-streams-18"},
  {title: "canada vs guatemala", url: "https://roxiestreams.live/soccer-streams-19"},
  {title: "indiana pacers vs new orleans pelicans", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "cleveland cavaliers vs philadelphia 76ers", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "brooklyn nets vs chicago bulls", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "los angeles clippers vs toronto raptors", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "houston rockets vs minnesota timberwolves", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "sacramento kings vs washington wizards", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "detroit red wings vs san jose sharks", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "carolina hurricanes vs florida panthers", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "st. louis blues vs tampa bay lightning", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "colorado avalanche vs nashville predators", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "anaheim ducks vs los angeles kings", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "buffalo sabres vs minnesota wild", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "new york rangers vs philadelphia flyers", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "calgary flames vs new york islanders", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "seattle kraken vs utah mammoth", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "montreal canadiens vs ottawa senators", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "carolina hurricanes vs new jersey devils", url: "https://roxiestreams.live/nhl-streams-6"},
  {title: "columbus blue jackets vs pittsburgh penguins", url: "https://roxiestreams.live/nhl-streams-7"},
  {title: "florida panthers vs washington capitals", url: "https://roxiestreams.live/nhl-streams-8"},
  {title: "toronto maple leafs vs winnipeg jets", url: "https://roxiestreams.live/nhl-streams-9"},
  {title: "boston bruins vs chicago blackhawks", url: "https://roxiestreams.live/nhl-streams-10"},
  {title: "edmonton oilers vs vancouver canucks", url: "https://roxiestreams.live/nhl-streams-11"},
  {title: "nashville predators vs vegas golden knights", url: "https://roxiestreams.live/nhl-streams-12"},
  {title: "anaheim ducks vs los angeles kings", url: "https://roxiestreams.live/nhl-streams-13"},
  {title: "ama supercross - qualifying", url: "https://roxiestreams.live/supercross"},
  {title: "ama supercross - race", url: "https://roxiestreams.live/supercross"},
  {title: "wwe smackdown", url: "https://roxiestreams.live/wwe-streams"},
  {title: "buffalo bills vs denver broncos", url: "https://roxiestreams.live/nfl-streams-1"},
  {title: "san francisco 49ers vs seattle seahawks", url: "https://roxiestreams.live/nfl-streams-2"}
];

  const nbaTeams = new Set(["sacramento kings","portland trail blazers","memphis grizzlies","cleveland cavaliers","phoenix suns","philadelphia 76ers","san antonio spurs","minnesota timberwolves","new orleans pelicans","charlotte hornets","orlando magic","miami heat","new york knicks","los angeles lakers","golden state warriors","washington wizards","atlanta hawks","boston celtics","chicago bulls","houston rockets","toronto raptors","dallas mavericks","los angeles clippers","milwaukee bucks","indiana pacers","utah jazz","detroit pistons","oklahoma city thunder","denver nuggets"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.live/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.live/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.live/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.live/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.live/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.live/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
