(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "air force": "air force",
  "al nassr": "al nassr",
  "alabama": "alabama",
  "america": "america",
  "arizona": "arizona",
  "arkansas state": "arkansas state",
  "army": "army",
  "arsenal": "arsenal",
  "atlanta hawks": "atlanta hawks",
  "atletico mineiro": "atletico mineiro",
  "atlético madrid": "atlético madrid",
  "atlético san luis": "atlético san luis",
  "auburn": "auburn",
  "bahia": "bahia",
  "bayern": "bayern",
  "borussia m'gladbach": "borussia m'gladbach",
  "boston college": "boston college",
  "brest": "brest",
  "burnley": "burnley",
  "byu": "byu",
  "california": "california",
  "chelsea": "chelsea",
  "chicago bulls": "chicago bulls",
  "cincinnati": "cincinnati",
  "clemson": "clemson",
  "cleveland cavaliers": "cleveland cavaliers",
  "colo-colo": "colo-colo",
  "colorado": "colorado",
  "colorado state": "colorado state",
  "columbus crew": "columbus crew",
  "cruz azul": "cruz azul",
  "dallas mavericks": "dallas mavericks",
  "deportivo alavés": "deportivo alavés",
  "dever nuggets": "dever nuggets",
  "duke": "duke",
  "espanyol": "espanyol",
  "everton": "everton",
  "florida": "florida",
  "florida state": "florida state",
  "formula 1 - free practice": "formula 1 - free practice",
  "formula 1 - qualifying": "formula 1 - qualifying",
  "formula 1 - sao paulo grand prix": "formula 1 - sao paulo grand prix",
  "formula 1 - sprint": "formula 1 - sprint",
  "formula 1 - sprint qualifying": "formula 1 - sprint qualifying",
  "fulham": "fulham",
  "georgia": "georgia",
  "girona": "girona",
  "guadalajara": "guadalajara",
  "indiana": "indiana",
  "indiana pacers": "indiana pacers",
  "inter miami": "inter miami",
  "internacional": "internacional",
  "iowa": "iowa",
  "iowa state": "iowa state",
  "james madison": "james madison",
  "juventude": "juventude",
  "juventus": "juventus",
  "kansas": "kansas",
  "kentucky": "kentucky",
  "köln": "köln",
  "le havre": "le havre",
  "lens": "lens",
  "levante": "levante",
  "león": "león",
  "los angeles clipeprs": "los angeles clipeprs",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles lakers": "los angeles lakers",
  "louisville": "louisville",
  "lsu": "lsu",
  "manchester united": "manchester united",
  "marseille": "marseille",
  "marshall": "marshall",
  "maryland": "maryland",
  "miami (fl)": "miami (fl)",
  "miami heat": "miami heat",
  "milan": "milan",
  "minnesota united": "minnesota united",
  "mississippi state": "mississippi state",
  "missouri": "missouri",
  "monaco": "monaco",
  "monterrey": "monterrey",
  "motogp - grand prix of portugal": "motogp - grand prix of portugal",
  "nantes": "nantes",
  "nashville": "nashville",
  "navy": "navy",
  "nebraska": "nebraska",
  "neom": "neom",
  "nevada": "nevada",
  "new orleans pelicans": "new orleans pelicans",
  "north carolina": "north carolina",
  "notre dame": "notre dame",
  "ohio state": "ohio state",
  "oregon": "oregon",
  "oregon state": "oregon state",
  "osasuna": "osasuna",
  "parma": "parma",
  "penn state": "penn state",
  "philadelphia 76ers": "philadelphia 76ers",
  "phoenix suns": "phoenix suns",
  "portland trail blazers": "portland trail blazers",
  "puebla": "puebla",
  "pumas unam": "pumas unam",
  "purdue": "purdue",
  "rutgers": "rutgers",
  "sam houston": "sam houston",
  "san antonio spurs": "san antonio spurs",
  "san jose state": "san jose state",
  "seattle sounders": "seattle sounders",
  "sevilla": "sevilla",
  "smu": "smu",
  "south dakota state vsw south dakota": "south dakota state vsw south dakota",
  "southern miss": "southern miss",
  "sport recife": "sport recife",
  "stanford": "stanford",
  "sunderland": "sunderland",
  "syracuse": "syracuse",
  "tcu": "tcu",
  "temple": "temple",
  "texas a&m": "texas a&m",
  "texas tech": "texas tech",
  "tigres uanl": "tigres uanl",
  "toluca": "toluca",
  "torino": "torino",
  "tornoto raptors": "tornoto raptors",
  "toronto blue jays": "toronto blue jays",
  "tottenham": "tottenham",
  "ucla": "ucla",
  "uconn": "uconn",
  "union berlin": "union berlin",
  "unión española": "unión española",
  "unlv": "unlv",
  "utah state": "utah state",
  "vanderbilt": "vanderbilt",
  "vasco da gama": "vasco da gama",
  "villarreal": "villarreal",
  "virginia": "virginia",
  "wake forest": "wake forest",
  "washington": "washington",
  "washington wizard": "washington wizard",
  "west ham": "west ham",
  "west virginia": "west virginia",
  "wisconsin": "wisconsin",
  "wolves": "wolves",
  "wwe smackdown": "wwe smackdown",
  "hawks": "atlanta hawks",
  "bulls": "chicago bulls",
  "cavaliers": "cleveland cavaliers",
  "mavericks": "dallas mavericks",
  "pacers": "indiana pacers",
  "lakers": "los angeles lakers",
  "heat": "miami heat",
  "pelicans": "new orleans pelicans",
  "sixers": "philadelphia 76ers",
  "suns": "phoenix suns",
  "blazers": "portland trail blazers",
  "spurs": "san antonio spurs"
};

  const roxieStreamsCached = [
  {title: "manchester united vs tottenham", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "deportivo alavés vs girona", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "al nassr vs neom", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "bayern vs union berlin", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "everton vs fulham", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "burnley vs west ham", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "osasuna vs sevilla", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "brest vs marseille", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "juventus vs torino", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "atlético madrid vs levante", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "borussia m'gladbach vs köln", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "arsenal vs sunderland", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "le havre vs nantes", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "colo-colo vs unión española", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "atletico mineiro vs sport recife", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "milan vs parma", url: "https://roxiestreams.live/soccer-streams-12"},
  {title: "chelsea vs wolves", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "espanyol vs villarreal", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "lens vs monaco", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "juventude vs vasco da gama", url: "https://roxiestreams.live/soccer-streams-13"},
  {title: "minnesota united vs seattle sounders", url: "https://roxiestreams.live/soccer-streams-14"},
  {title: "bahia vs internacional", url: "https://roxiestreams.live/soccer-streams-15"},
  {title: "atlético san luis vs tigres uanl", url: "https://roxiestreams.live/soccer-streams-16"},
  {title: "cincinnati vs columbus crew", url: "https://roxiestreams.live/soccer-streams-17"},
  {title: "guadalajara vs monterrey", url: "https://roxiestreams.live/soccer-streams-16"},
  {title: "inter miami vs nashville", url: "https://roxiestreams.live/soccer-streams-18"},
  {title: "león vs puebla", url: "https://roxiestreams.live/soccer-streams-19"},
  {title: "america vs toluca", url: "https://roxiestreams.live/soccer-streams-20"},
  {title: "cruz azul vs pumas unam", url: "https://roxiestreams.live/soccer-streams-20"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "dallas mavericks vs washington wizard", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "philadelphia 76ers vs tornoto raptors", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "miami heat vs portland trail blazers", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "chicago bulls vs cleveland cavaliers", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "atlanta hawks vs los angeles lakers", url: "https://roxiestreams.live/nba-streams-5"},
  {title: "new orleans pelicans vs san antonio spurs", url: "https://roxiestreams.live/nba-streams-6"},
  {title: "dever nuggets vs indiana pacers", url: "https://roxiestreams.live/nba-streams-7"},
  {title: "los angeles clipeprs vs phoenix suns", url: "https://roxiestreams.live/nba-streams-8"},
  {title: "formula 1 - free practice", url: "https://roxiestreams.live/f1-streams"},
  {title: "formula 1 - sprint qualifying", url: "https://roxiestreams.live/f1-streams"},
  {title: "formula 1 - sprint", url: "https://roxiestreams.live/f1-streams"},
  {title: "formula 1 - qualifying", url: "https://roxiestreams.live/f1-streams"},
  {title: "motogp - grand prix of portugal", url: "https://roxiestreams.live/motogp"},
  {title: "formula 1 - sao paulo grand prix", url: "https://roxiestreams.live/f1-streams"},
  {title: "wwe smackdown", url: "https://roxiestreams.live/wwe-streams"},
  {title: "georgia vs mississippi state", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "byu vs texas tech", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "indiana vs penn state", url: "https://roxiestreams.live/ncaa-streams-3"},
  {title: "boston college vs smu", url: "https://roxiestreams.live/ncaa-streams-4"},
  {title: "colorado vs west virginia", url: "https://roxiestreams.live/ncaa-streams-5"},
  {title: "james madison vs marshall", url: "https://roxiestreams.live/ncaa-streams-6"},
  {title: "arkansas state vs southern miss", url: "https://roxiestreams.live/ncaa-streams-7"},
  {title: "army vs temple", url: "https://roxiestreams.live/ncaa-streams-8"},
  {title: "ohio state vs purdue", url: "https://roxiestreams.live/ncaa-streams-9"},
  {title: "maryland vs rutgers", url: "https://roxiestreams.live/ncaa-streams-10"},
  {title: "arizona vs kansas", url: "https://roxiestreams.live/ncaa-streams-6"},
  {title: "iowa state vs tcu", url: "https://roxiestreams.live/ncaa-streams-3"},
  {title: "miami (fl) vs syracuse", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "missouri vs texas a&m", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "iowa vs oregon", url: "https://roxiestreams.live/ncaa-streams-11"},
  {title: "duke vs uconn", url: "https://roxiestreams.live/ncaa-streams-8"},
  {title: "auburn vs vanderbilt", url: "https://roxiestreams.live/ncaa-streams-12"},
  {title: "south dakota state vsw south dakota", url: "https://roxiestreams.live/ncaa-streams-7"},
  {title: "washington vs wisconsin", url: "https://roxiestreams.live/ncaa-streams-9"},
  {title: "north carolina vs stanford", url: "https://roxiestreams.live/ncaa-streams-13"},
  {title: "air force vs san jose state", url: "https://roxiestreams.live/ncaa-streams-10"},
  {title: "california vs louisville", url: "https://roxiestreams.live/ncaa-streams-6"},
  {title: "clemson vs florida state", url: "https://roxiestreams.live/ncaa-streams-4"},
  {title: "virginia vs wake forest", url: "https://roxiestreams.live/ncaa-streams-1"},
  {title: "navy vs notre dame", url: "https://roxiestreams.live/ncaa-streams-14"},
  {title: "alabama vs lsu", url: "https://roxiestreams.live/ncaa-streams-2"},
  {title: "florida vs kentucky", url: "https://roxiestreams.live/ncaa-streams-12"},
  {title: "nevada vs utah state", url: "https://roxiestreams.live/ncaa-streams-8"},
  {title: "nebraska vs ucla", url: "https://roxiestreams.live/ncaa-streams-3"},
  {title: "colorado state vs unlv", url: "https://roxiestreams.live/ncaa-streams-10"},
  {title: "oregon state vs sam houston", url: "https://roxiestreams.live/ncaa-streams-13"}
];

  const nbaTeams = new Set(["golden state warriors","miami heat","denver nuggets","oklahoma city thunder","boston celtics","houston rockets","los angeles lakers","toronto raptors","sacramento kings","philadelphia 76ers","memphis grizzlies","washington wizards","new york knicks","charlotte hornets","portland trail blazers","milwaukee bucks","phoenix suns","orlando magic","indiana pacers","chicago bulls","atlanta hawks","los angeles clippers","new orleans pelicans","minnesota timberwolves","san antonio spurs","cleveland cavaliers","dallas mavericks","utah jazz","detroit pistons"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.cc/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.cc/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.cc/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.cc/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.cc/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 400)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.cc/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 400));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 400));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
