(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "bangu": "bangu",
  "barcelona": "barcelona",
  "brentford": "brentford",
  "cagliari": "cagliari",
  "coventry city": "coventry city",
  "fluminense": "fluminense",
  "girona": "girona",
  "leece": "leece",
  "macclesfield": "macclesfield",
  "middlesbrough": "middlesbrough",
  "nascar cup series - daytona": "nascar cup series - daytona",
  "nba all-star sunday": "nba all-star sunday",
  "wwe raw": "wwe raw"
};

  const roxieStreamsCached = [
  {title: "brentford vs macclesfield", url: "https://roxiestreams.info/soccer-streams-1"},
  {title: "cagliari vs leece", url: "https://roxiestreams.info/soccer-streams-2"},
  {title: "barcelona vs girona", url: "https://roxiestreams.info/soccer-streams-3"},
  {title: "coventry city vs middlesbrough", url: "https://roxiestreams.info/soccer-streams-4"},
  {title: "bangu vs fluminense", url: "https://roxiestreams.info/soccer-streams-5"},
  {title: "nba all-star sunday", url: "https://roxiestreams.info/nba-streams-1"},
  {title: "nascar cup series - daytona", url: "https://roxiestreams.info/nascar"},
  {title: "wwe raw", url: "https://roxiestreams.info/wwe-streams"}
];

  const nbaTeams = new Set(["indiana pacers","minnesota timberwolves","los angeles lakers","golden state warriors","new orleans pelicans","sacramento kings","milwaukee bucks","washington wizards","toronto raptors","san antonio spurs","utah jazz","cleveland cavaliers","detroit pistons","orlando magic","memphis grizzlies","chicago bulls","new york knicks","houston rockets","atlanta hawks","portland trail blazers","dallas mavericks","los angeles clippers","denver nuggets","charlotte hornets","miami heat","philadelphia 76ers","phoenix suns","oklahoma city thunder","boston celtics"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

  function normalizeTeamName(name) {
    return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
  }

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

  const normalizedCache = roxieStreamsCached.map(item => ({ 
    title: normalizeTitle(item.title),
    url: item.url
  }));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.info/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.info/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.info/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.info/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.info/missing';
  }

  function getEventTitleFromGameItem(gameItem) {
    if (!gameItem) return '';
    const matchupDiv = gameItem.querySelector('.game-matchup');
    if (!matchupDiv) return '';
    return matchupDiv.textContent.trim();
  }

  function getLeagueFromGameItem(gameItem) {
    const broadcastDiv = gameItem.querySelector('.game-broadcast');
    return broadcastDiv ? broadcastDiv.textContent.trim() : '';
  }

  function autofillHandler(e) {
    const button = e.currentTarget;
    const gameId = button.getAttribute('data-modal');
    const gameItem = button.closest('.game-item');

    const eventTitle = getEventTitleFromGameItem(gameItem);
    const leagueText = getLeagueFromGameItem(gameItem);
    console.log('Extracted event title:', eventTitle, 'league:', leagueText, 'gameId:', gameId);

    let channelName = '';

    const lowerTitle = eventTitle.toLowerCase();

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => lowerTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (lowerTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (lowerTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (lowerTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => lowerTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => lowerTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => lowerTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const modal = document.getElementById(`modal-${gameId}`);
      if (!modal) {
        console.warn('Modal not found for gameId:', gameId);
        return;
      }

      const form = modal.querySelector('form.stream-form');
      if (!form) {
        console.warn('Form not found in modal for gameId:', gameId);
        return;
      }

      const streamUrl = findBestMatch(eventTitle);

      const siteInput = form.querySelector('input[name="site"]');
      const urlInput = form.querySelector('input[name="url"]');
      const channelInput = form.querySelector('input[name="channel"]');
      const bitrateInput = form.querySelector('input[name="bitrate"]');
      const adsSelect = form.querySelector('select[name="ads"]');
      const fpsSelect = form.querySelector('select[name="fps"]');

      if (siteInput) siteInput.value = 'RoxieStreams';
      if (urlInput) urlInput.value = streamUrl;
      if (channelInput) channelInput.value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      if (bitrateInput) bitrateInput.value = '7000';
      if (adsSelect) adsSelect.value = '0';
      if (fpsSelect) fpsSelect.value = '60';

      form.querySelectorAll('input[type="checkbox"][name="Compatibility"]').forEach(cb => {
        cb.checked = true;
      });

      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0 for gameId ${gameId}`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add-btn').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add-btn'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-modal');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300));

      const modal = document.getElementById(`modal-${gameId}`);
      if (!modal) {
        console.warn(`Modal not found for gameId: ${gameId}`);
        continue;
      }
      const form = modal.querySelector('form.stream-form');
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }

      const urlInput = form.querySelector('input[name="url"]');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }

      const urlValue = urlInput.value.trim();

      if (urlValue === 'https://roxiestreams.info/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      const submitBtn = form.querySelector('button.submit-btn[type="submit"]');
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked submit button for ${gameId}`);
      } else {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }

      await new Promise(res => setTimeout(res, 300));
    }
  }

  autoProcessAllEvents();

  window.autoProcessAllEvents = autoProcessAllEvents;
})();
