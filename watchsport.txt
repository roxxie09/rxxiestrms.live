(async () => {
  if (!window.Fuse) {
    await new Promise((resolve, reject) => {
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/fuse.js@7.0.0';
      script.onload = resolve;
      script.onerror = reject;
      document.head.appendChild(script);
    });
  }

  const teamNameMap = {
  "aberdeen": "aberdeen",
  "aew": "aew",
  "anaheim ducks": "anaheim ducks",
  "aston villa": "aston villa",
  "atalanta falcons": "atalanta falcons",
  "basel": "basel",
  "bologna": "bologna",
  "boston bruins": "boston bruins",
  "boston celtics": "boston celtics",
  "buffalo sabres": "buffalo sabres",
  "calgary flames": "calgary flames",
  "carolina hurricanes": "carolina hurricanes",
  "celta de vigo": "celta de vigo",
  "celtic": "celtic",
  "chicago blackhawks": "chicago blackhawks",
  "colorado avalanche": "colorado avalanche",
  "columbus blue jackets": "columbus blue jackets",
  "crystal palace": "crystal palace",
  "dallas stars": "dallas stars",
  "denver nuggets": "denver nuggets",
  "detroit red wings": "detroit red wings",
  "dinamo zagreb": "dinamo zagreb",
  "edmonton oilers": "edmonton oilers",
  "ferencváros": "ferencváros",
  "florida panthers": "florida panthers",
  "fluminense": "fluminense",
  "go ahead eagles": "go ahead eagles",
  "houston rockets": "houston rockets",
  "kubota high limit racing - prelim night 1": "kubota high limit racing - prelim night 1",
  "kubota high limit racing - prelim night 2": "kubota high limit racing - prelim night 2",
  "kubota high limit racing - race": "kubota high limit racing - race",
  "lille": "lille",
  "los angeles clippers": "los angeles clippers",
  "los angeles dodgers": "los angeles dodgers",
  "los angeles kings": "los angeles kings",
  "los angeles lakers": "los angeles lakers",
  "lyon": "lyon",
  "malmo ff": "malmo ff",
  "milwaukee bucks": "milwaukee bucks",
  "minnesota wild": "minnesota wild",
  "montreal canadiens": "montreal canadiens",
  "nashville predators": "nashville predators",
  "new jersey devils": "new jersey devils",
  "new orleans pelicans": "new orleans pelicans",
  "new york islanders": "new york islanders",
  "new york rangers": "new york rangers",
  "nice": "nice",
  "nottingham forest": "nottingham forest",
  "oklahoma city thunder": "oklahoma city thunder",
  "ottawa senators": "ottawa senators",
  "philadelphia flyers": "philadelphia flyers",
  "phoenix suns": "phoenix suns",
  "pittsburgh penguins": "pittsburgh penguins",
  "portland trail blazers": "portland trail blazers",
  "porto": "porto",
  "rangers": "rangers",
  "real betis": "real betis",
  "roma": "roma",
  "sacramento kings": "sacramento kings",
  "san antonio spurs": "san antonio spurs",
  "san jose sharks": "san jose sharks",
  "seattle kraken": "seattle kraken",
  "shelbourne": "shelbourne",
  "sporting braga": "sporting braga",
  "st. louis blues": "st. louis blues",
  "strasbourg": "strasbourg",
  "tamapa bay buccaneers": "tamapa bay buccaneers",
  "tampa bay lightning": "tampa bay lightning",
  "tigres uanl": "tigres uanl",
  "toluca": "toluca",
  "toronto blue jays": "toronto blue jays",
  "toronto maple leafs": "toronto maple leafs",
  "utah mammoth": "utah mammoth",
  "utrecht": "utrecht",
  "vancouver canucks": "vancouver canucks",
  "vasco da gama": "vasco da gama",
  "vegas golden knights": "vegas golden knights",
  "washington capitals": "washington capitals",
  "winnipeg jets": "winnipeg jets",
  "young boys": "young boys",
  "celtics": "boston celtics",
  "nuggets": "denver nuggets",
  "rockets": "houston rockets",
  "clippers": "los angeles clippers",
  "lakers": "los angeles lakers",
  "bucks": "milwaukee bucks",
  "pelicans": "new orleans pelicans",
  "thunder": "oklahoma city thunder",
  "suns": "phoenix suns",
  "blazers": "portland trail blazers",
  "kings": "sacramento kings",
  "spurs": "san antonio spurs"
};

  const roxieStreamsCached = [
  {title: "dinamo zagreb vs real betis", url: "https://roxiestreams.live/soccer-streams-1"},
  {title: "ferencváros vs rangers", url: "https://roxiestreams.live/soccer-streams-2"},
  {title: "nottingham forest vs utrecht", url: "https://roxiestreams.live/soccer-streams-3"},
  {title: "nice vs sporting braga", url: "https://roxiestreams.live/soccer-streams-4"},
  {title: "lille vs young boys", url: "https://roxiestreams.live/soccer-streams-5"},
  {title: "aberdeen vs strasbourg", url: "https://roxiestreams.live/soccer-streams-6"},
  {title: "aston villa vs basel", url: "https://roxiestreams.live/soccer-streams-7"},
  {title: "celtic vs roma", url: "https://roxiestreams.live/soccer-streams-8"},
  {title: "bologna vs celta de vigo", url: "https://roxiestreams.live/soccer-streams-9"},
  {title: "crystal palace vs shelbourne", url: "https://roxiestreams.live/soccer-streams-10"},
  {title: "malmo ff vs porto", url: "https://roxiestreams.live/soccer-streams-11"},
  {title: "go ahead eagles vs lyon", url: "https://roxiestreams.live/soccer-streams-12"},
  {title: "fluminense vs vasco da gama", url: "https://roxiestreams.live/soccer-streams-13"},
  {title: "tigres uanl vs toluca", url: "https://roxiestreams.live/soccer-streams-14"},
  {title: "oklahoma city thunder vs phoenix suns", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "los angeles lakers vs san antonio spurs", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "houston rockets vs los angeles clippers", url: "https://roxiestreams.live/nba-streams-1"},
  {title: "boston celtics vs milwaukee bucks", url: "https://roxiestreams.live/nba-streams-2"},
  {title: "new orleans pelicans vs portland trail blazers", url: "https://roxiestreams.live/nba-streams-3"},
  {title: "denver nuggets vs sacramento kings", url: "https://roxiestreams.live/nba-streams-4"},
  {title: "los angeles dodgers vs toronto blue jays", url: "https://roxiestreams.live/mlb-streams-1"},
  {title: "chicago blackhawks vs new york rangers", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "calgary flames vs detroit red wings", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "florida panthers vs utah mammoth", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "los angeles kings vs seattle kraken", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "san jose sharks vs toronto maple leafs", url: "https://roxiestreams.live/nhl-streams-1"},
  {title: "new jersey devils vs tampa bay lightning", url: "https://roxiestreams.live/nhl-streams-2"},
  {title: "anaheim ducks vs new york islanders", url: "https://roxiestreams.live/nhl-streams-3"},
  {title: "philadelphia flyers vs vegas golden knights", url: "https://roxiestreams.live/nhl-streams-4"},
  {title: "montreal canadiens vs pittsburgh penguins", url: "https://roxiestreams.live/nhl-streams-5"},
  {title: "carolina hurricanes vs washington capitals", url: "https://roxiestreams.live/nhl-streams-6"},
  {title: "columbus blue jackets vs ottawa senators", url: "https://roxiestreams.live/nhl-streams-7"},
  {title: "nashville predators vs st. louis blues", url: "https://roxiestreams.live/nhl-streams-8"},
  {title: "dallas stars vs minnesota wild", url: "https://roxiestreams.live/nhl-streams-9"},
  {title: "boston bruins vs winnipeg jets", url: "https://roxiestreams.live/nhl-streams-10"},
  {title: "detroit red wings vs edmonton oilers", url: "https://roxiestreams.live/nhl-streams-11"},
  {title: "colorado avalanche vs florida panthers", url: "https://roxiestreams.live/nhl-streams-12"},
  {title: "buffalo sabres vs vancouver canucks", url: "https://roxiestreams.live/nhl-streams-13"},
  {title: "kubota high limit racing - prelim night 1", url: "https://roxiestreams.live/floracing-1"},
  {title: "kubota high limit racing - prelim night 2", url: "https://roxiesWtreams.live/floracing-1"},
  {title: "kubota high limit racing - race", url: "https://roxiestreams.live/floracing-1"},
  {title: "aew", url: "https://roxiestreams.live/aew"},
  {title: "atalanta falcons vs tamapa bay buccaneers", url: "https://roxiestreams.live/nfl-streams-1"}
];

  const nbaTeams = new Set(["portland trail blazers","new york knicks","los angeles clippers","chicago bulls","san antonio spurs","oklahoma city thunder","indiana pacers","milwaukee bucks","detroit pistons","denver nuggets","dallas mavericks","los angeles lakers","miami heat","boston celtics","houston rockets","toronto raptors","minnesota timberwolves","washington wizards","orlando magic","philadelphia 76ers","sacramento kings","golden state warriors","atlanta hawks","phoenix suns","charlotte hornets","new orleans pelicans","utah jazz","cleveland cavaliers","memphis grizzlies"]);
  const premierLeagueTeams = new Set(["leeds","west ham","c palace","nottm forest","man united","man city","newcastle","brighton","brentford","liverpool","spurs"]);
  const laLigaTeams = new Set(["alaves","athletic bilbao","atm","atletico madrid","barcelona","celta vigo","elche","espanyol","getafe","girona","mallorca","osasuna","rayo vallecano","real betis","real madrid","real sociedad","real valladolid","sevilla","valencia","villarreal"]);
  const mlsTeams = new Set(["miami","atlanta","chicago","cincinnati","columbus","dallas","dc","houston","los angeles","minnesota","nashville","new england","new york","orlando","philadelphia","portland","real salt lake","seattle","sporting kansas city","san jose","toronto","vancouver"]);

function normalizeTeamName(name) {
  return teamNameMap[name.toLowerCase().trim()] || name.toLowerCase().trim();
}

  function normalizeTitle(title) {
    let t = title.toLowerCase().replace(/@/g, 'vs').trim();
    if (!t.includes('vs')) {
      return normalizeTeamName(t);
    }
    let teams = t.split('vs').map(s => normalizeTeamName(s.trim()));
    teams.sort();
    return teams.join(' vs ');
  }

const normalizedCache = roxieStreamsCached.map(item => ({
  title: normalizeTitle(item.title),
  url: item.url
}));

  const fuse = new Fuse(normalizedCache, {
    keys: ['title'],
    threshold: 0.3,
    includeScore: true,
    distance: 50,
    ignoreLocation: true,
  });

  function findBestMatch(eventTitle) {
    const lowerTitle = eventTitle.toLowerCase();
    if (lowerTitle.includes("ufc")) return "https://roxiestreams.live/ufc";
    if (lowerTitle.includes("grand prix")) return "https://roxiestreams.live/f1-streams";
    if (lowerTitle.includes("wwe")) return "https://roxiestreams.live/wwe-streams";

    let teams = [];
    if (lowerTitle.includes("@")) {
      teams = lowerTitle.split("@").map(t => normalizeTeamName(t.trim()));
    } else if (lowerTitle.includes("vs")) {
      teams = lowerTitle.split("vs").map(t => normalizeTeamName(t.trim()));
    } else {
      teams = [normalizeTeamName(lowerTitle.trim())];
    }

    if (teams.length === 0) return 'https://roxiestreams.live/missing';

    for (const entry of normalizedCache) {
      for (const team of teams) {
        if (entry.title.includes(team)) return entry.url;
      }
    }
    return 'https://roxiestreams.live/missing';
  }

  function getEventTitleFromListDiv(listDiv) {
    if (!listDiv) return '';
    let titleText = '';
    listDiv.childNodes.forEach(node => {
      if (node.nodeType === Node.TEXT_NODE) {
        const trimmed = node.textContent.trim();
        if (trimmed) titleText += trimmed + ' ';
      }
    });
    return titleText.trim();
  }

  function autofillHandler(e) {
    const gameId = e.currentTarget.getAttribute('data-target');
    const listDiv = e.currentTarget.closest('.list');
    const eventTitle = getEventTitleFromListDiv(listDiv).toLowerCase();
    console.log('Extracted event title:', eventTitle, 'for gameId:', gameId);

    let channelName = '';
    const leagueSpan = listDiv ? listDiv.querySelector('span.league') : null;
    if (leagueSpan) {
      const leagueText = leagueSpan.textContent.trim();
      if (!/^\d/.test(leagueText)) {
        channelName = leagueText;
      }
    }

    const nbaShortNames = Object.keys(teamNameMap).filter(key => nbaTeams.has(teamNameMap[key].toLowerCase()));
    const hasNbaShortName = nbaShortNames.some(shortName => eventTitle.includes(shortName.toLowerCase()));

    if ((!channelName || channelName.trim() === '') && hasNbaShortName) {
      channelName = 'NBA League Pass';
    }

    if (eventTitle.includes('wwe')) {
      channelName = 'Netflix';
    }

    if (eventTitle.includes('grand prix')) {
      channelName = 'Sky Sports F1';
    }

    if (eventTitle.includes('ufc')) {
      channelName = 'ESPN+';
    }

    const hasPlTeam = Array.from(premierLeagueTeams).some(plTeam => eventTitle.includes(plTeam));
    if ((!channelName || channelName.trim() === '') && hasPlTeam) {
      channelName = 'Now Sports';
    }

    const hasLaLigaTeam = Array.from(laLigaTeams).some(laTeam => eventTitle.includes(laTeam));
    if ((!channelName || channelName.trim() === '') && hasLaLigaTeam) {
      channelName = 'ESPN Deportes';
    }

    const hasMlsTeam = Array.from(mlsTeams).some(mlsTeam => eventTitle.includes(mlsTeam));
    if ((!channelName || channelName.trim() === '') && hasMlsTeam) {
      channelName = 'MLS Season Pass';
    }

    setTimeout(() => {
      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn('Form not found for gameId:', gameId);
        return;
      }
      const streamUrl = findBestMatch(eventTitle);
      form.querySelector('#site').value = 'RoxieStreams';
      form.querySelector('#url').value = streamUrl;
      form.querySelector('#channel').value = (channelName ? (channelName + ' (FHD)') : 'Main (FHD)');
      form.querySelector('#fps').value = '60';

      const bitrateInput = form.querySelector('#bitrate') || form.querySelector('input[name="bitrate"]');
      if (bitrateInput) bitrateInput.value = '7000';

      const adsInput = form.querySelector('#ads') || form.querySelector('input[name="ads"]') || form.querySelector('input[name="numAds"]');
      if (adsInput) adsInput.value = '0';

      form.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
      console.log(`Autofilled URL: ${streamUrl} and channel: ${channelName} with bitrate 7000 and ads 0`);
    }, 300);
  }

  function attachAutofill() {
    document.querySelectorAll('button.add.modal-trigger').forEach(button => {
      button.removeEventListener('click', autofillHandler);
      button.addEventListener('click', autofillHandler);
    });
  }

  attachAutofill();

  async function autoProcessAllEvents() {
    const buttons = Array.from(document.querySelectorAll('button.add.modal-trigger'));

    for (const button of buttons) {
      const gameId = button.getAttribute('data-target');
      console.log(`Opening modal for gameId ${gameId}`);
      button.dispatchEvent(new MouseEvent('click', { bubbles: true, cancelable: true }));

      await new Promise(res => setTimeout(res, 300)); // Wait for autofill

      const form = document.querySelector(`#form-${gameId}`);
      if (!form) {
        console.warn(`Form not found for gameId: ${gameId}`);
        continue;
      }
      const urlInput = form.querySelector('#url');
      if (!urlInput) {
        console.warn(`URL input not found for gameId: ${gameId}`);
        continue;
      }
      const urlValue = urlInput.value.trim();

      // SKIP modals/events whose URL is "missing"
      if (urlValue === 'https://roxiestreams.live/missing') {
        console.log(`Skipping ${gameId}: URL is missing!`);
        // Optionally: You may wish to close the modal here so it doesn't remain open, OR ignore and let user close after
        // If you want to close, uncomment below:
        // const closeBtn = document.querySelector(`#submit-${gameId}`);
        // if (closeBtn) closeBtn.click();
        await new Promise(res => setTimeout(res, 300));
        continue;
      }

      // Valid URL found, click external submit button to save/close
      const submitBtn = document.querySelector(`#submit-${gameId}`);
      if (submitBtn) {
        submitBtn.focus();
        submitBtn.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        console.log(`Clicked external submit button for ${gameId}`);
      } else if (form) {
        form.submit();
        console.log(`Fallback: submitted form element for ${gameId}`);
      }
      await new Promise(res => setTimeout(res, 300));
    }
  }

  // Start automated modal processing
  autoProcessAllEvents();

  // For manual reruns, expose to window
  window.autoProcessAllEvents = autoProcessAllEvents;
})();
